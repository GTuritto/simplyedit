<section id="vedor-text-cursor" class="vedor-section">
	<h1>*HTML Toolbar for Text Cursor*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-section="vedor-text-style" class="vedor-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-vedor-section="vedor-text-align" class="vedor-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-vedor-section="vedor-clipboard" class="vedor-expands"><i class="fa fa-clipboard"></i>Clipboard</button></li>
			<li><button data-vedor-section="vedor-insert" class="vedor-expands"><i class="fa fa-plus"></i>Insert</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-text-style">
			<ul>
				<li class="vedor-text-format"><select name="textStyle" data-vedor-action="vedor-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
					<option value="ul">Unnumbered list</option>
					<option value="ol">Numbered list</option>
				</select></li>
				<!-- li class="vedor-text-bold"><button data-vedor-action="vedor-text-bold"><i class="fa fa-bold"></i>Bold</button></li>
				<li class="vedor-text-italic"><button data-vedor-action="vedor-text-italic"><i class="fa fa-italic"></i>Italic</button></li>
				<li class="vedor-text-underline"><button data-vedor-action="vedor-text-underline"><i class="fa fa-underline"></i>Underline</button></li -->
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-text-align" data-type="vedor-buttongroup-radio">
			<ul>
			<li><button data-vedor-action="vedor-text-align-left" data-value="left" class="vedor-align-left"><i class="fa fa-align-left"></i>Left</button></li>
			<li><button data-vedor-action="vedor-text-align-center" data-value="center" class="vedor-align-center"><i class="fa fa-align-center"></i>Center</button></li>
			<li><button data-vedor-action="vedor-text-align-right" data-value="right" class="vedor-align-right"><i class="fa fa-align-right"></i>Right</button></li>
			<li><button data-vedor-action="vedor-text-align-justify" data-value="justify" class="vedor-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-insert">
			<ul>
				<li><button data-vedor-action="vedor-insert-image" data-vedor-section="vedor-insert-image"><i class="fa fa-picture-o"></i>Image</button></li>
				<!-- li><button data-vedor-action="vedor-insert-table" data-vedor-section="vedor-insert-table"><i class="fa fa-table"></i>Table
					<div id="vdTablePopup" style="display: none;" unselectable="on">
						<div id="vdTablePreview" unselectable="on">
						</div>
						<div id="vdTableText" unselectable="on">
						</div>
					</div>
				</button></li -->
				<!-- li><button data-vedor-action="vedor-insert-symbol" data-vedor-section="vedor-insert-symbol"><i class="fa fa-eur"></i>Symbol</button></li -->
				<li><button data-vedor-action="vedor-insert-gadget" data-vedor-section="vedor-insert-gadget"><i class="fa fa-puzzle-piece"></i>Gadget</button></li>
				<li><button data-vedor-action="vedor-insert-source" data-vedor-section="vedor-insert-source"><i class="fa fa-code"></i>Code</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-clipboard">
			<ul>
				<li><button class="vedor-clipboard-paste"><i class="fa fa-clipboard"></i>Paste</button></li>
				<li><button class="vedor-clipboard-select-all" data-vedor-action="vedor-clipboard-select-all"><i class="fa fa-arrows-alt"></i>Select all</button></li>
			</ul>
		</div>
	</div>
</section>
<section id="vedor-text-selection" class="vedor-section">
	<h1>*HTML Toolbar for Text Selection*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-section="vedor-text-style" class="vedor-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-vedor-section="vedor-text-align" class="vedor-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-vedor-section="vedor-clipboard" class="vedor-expands"><i class="fa fa-clipboard"></i>Clipboard</button></li>
			<li><button data-vedor-section="vedor-hyperlink" class="vedor-expands"><i class="fa fa-link"></i>Link</button></li>
			<li><button data-vedor-section="vedor-code" data-vedor-action="vedor-edit-source"><i class="fa fa-code"></i>Code</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-text-style">
			<ul>
				<li class="vedor-text-format"><select name="textStyle" data-vedor-action="vedor-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
					<option value="ul">Unnumbered list</option>
					<option value="ol">Numbered list</option>
				</select></li>
				<li class="vedor-text-bold"><button data-vedor-action="vedor-text-bold"><i class="fa fa-bold"></i>Bold</button></li>
				<li class="vedor-text-italic"><button data-vedor-action="vedor-text-italic"><i class="fa fa-italic"></i>Italic</button></li>
				<li class="vedor-text-underline"><button data-vedor-action="vedor-text-underline"><i class="fa fa-underline"></i>Underline</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-text-align" data-type="vedor-buttongroup-radio">
			<ul>
			<li><button data-vedor-action="vedor-text-align-left" data-value="left" class="vedor-align-left"><i class="fa fa-align-left"></i>Left</button></li>
			<li><button data-vedor-action="vedor-text-align-center" data-value="center" class="vedor-align-center"><i class="fa fa-align-center"></i>Center</button></li>
			<li><button data-vedor-action="vedor-text-align-right" data-value="right" class="vedor-align-right"><i class="fa fa-align-right"></i>Right</button></li>
			<li><button data-vedor-action="vedor-text-align-justify" data-value="justify" class="vedor-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-hyperlink">
			<div><label>URL</label><input type="text" id="vdHyperlinkHref" data-vedor-action="vedor-hyperlink-href"></div>
			<div><label>Title</label><input type="text" id="vdHyperlinkTitle" data-vedor-action="vedor-hyperlink-title"></div>
			<div><label>Name</label><input type="text" id="vdHyperlinkName" data-vedor-action="vedor-hyperlink-name"></div>
			<div><button class="vedor-hyperlink-nofollow" data-vedor-action="vedor-hyperlink-nofollow"><i class="fa fa-chain-broken"></i>Nofollow</button></div>
		</div>
		<div class="vedor-toolbar-section vedor-clipboard">
			<ul>
				<li><button class="vedor-clipboard-cut"><i class="fa fa-scissors"></i>Cut</button></li>
				<li><button class="vedor-clipboard-copy"><i class="fa fa-files-o"></i>Copy</button></li>
				<li><button class="vedor-clipboard-paste"><i class="fa fa-clipboard"></i>Paste</button></li>
				<li><button class="vedor-clipboard-select-all" data-vedor-action="vedor-clipboard-select-all"><i class="fa fa-arrows-alt"></i>Select all</button></li>
			</ul>
		</div>
	</div>
</section>
<script type="text/javascript">
	editor.plugins.text = {
		formatInline : function(command, value) {
			var field=editor.node.getEditableField();
			if (!field) {
				return;
			}
			registerChange(field.id);

			var sel = vdSelectionState.get();

			var target = document;
			if( !window.getSelection && target.selection.type != "None" ) { // make sure we execCommand on the selection for IE.
				target = sel;
			}

			editor.node.replaceTags("STRONG", "B");
			editor.node.replaceTags("EM", "I");
			target.execCommand(command, false, value);
			vdSelectionState.restore();

			editor.node.replaceTags("I", "EM");
			editor.node.replaceTags("B", "STRONG");

			vdStoreUndo();
			vdEditPane_DisplayChanged();
			return true;
		},
		formatBlock : function(styleInfo) {
			var field=editor.node.getEditableField();
			if (!field) {
				return false;
			}

			vedor.editor.styles.init(window);
			vedor.editor.styles.format(styleInfo, field);

			vdStoreUndo();

			vdEditPane_DisplayChanged();
			return true;
		}
	};

	editor.plugins.hyperlink = {
		create : function() {
			var tagList = []; // This holds the list of related hyperlink tags that the attributes will be set on;

			// first let the dhtmledit component set the link, since it is better in it.
			// but to find it back, we need a unique identifier

			var linkIdentifier=Math.floor(Math.random()*10000);
			editor.plugins.text.formatInline("CreateLink", '#'+linkIdentifier);
			var tags = document.querySelectorAll("A[href='#" + linkIdentifier + "']");

			for (var i=0; i<tags.length; i++) {
				tagList.push(tags[i]);
			}
			return tagList;
		},
		get : function() {
			var tagList = [];
			var element;
			var sel = vdSelectionState.get();
			var control = vdSelectionState.getControlNode(sel);
			if (control) {
				element = control;
				parent = element.parentNode;
			} else {
				if (sel.select) { // IE only
					var htmlText = vdSelection.getHTMLText(oSel);
					if (htmlText.substr(htmlText.length-4, 4)=='<BR>') {
						// BR included in selection as last element, remove it, it has
						// dangerous effects on the hyperlink command in IE
						sel.moveEnd('character',-1);
						sel.select();
					}
					if (htmlText.substr(0,4)=='<BR>') {
						// idem when its the first character
						sel.moveStart('character',1);
						sel.select();
					}

				}
				parent = vdSelection.parentNode(sel);
			}

			if (parent.tagName.toLowerCase() == 'a') {
				tagList.push(parent);
			}
			return tagList;
		},
		set : function(tagList, attributes) {
			var newTagList = [];

			var newLink="<a";
			for (var i in attributes) {
				if (attributes[i]) {
					newLink=newLink+" "+i+"=\""+attributes[i]+"\"";
				}
			}
			newLink=newLink+">";

			// Now set the link properties for all the elements in the list.
			for (var j=0; j<tagList.length; j++) {
				tag = tagList[j];

				if (tag && (attributes['href'] || attributes['name'])) {
					var div = document.createElement('div');
					div.innerHTML = newLink+tag.innerHTML+'</a>';
					var frag = document.createDocumentFragment();
					for (var i=0; i < div.childNodes.length; i++) {
						var node = div.childNodes[i].cloneNode(true);
						frag.appendChild(node);
						if (node.tagName.toLowerCase() == "a") {
							newTagList.push(node);
						}
					}
					div = null;
					tag.parentNode.replaceChild(frag, tag);
				}
			}
			currentLink = newTagList;
		}
	};

	var updateTextToolbar = function(toolbar) {
		var i;

		var sel = vdSelectionState.get();
		var parent = vdSelection.getNode(sel);
		vdSelectionState.save();
		currentLink = [];

		if (parent) {
			var foundTag = toolbar.querySelector("[name='textStyle'] option[value='" + parent.tagName.toLowerCase() + "']");
			if (foundTag) {
				foundTag.selected = true;
			}
			if (parent.tagName.toLowerCase() == "a") {
				currentLink.push(parent);
			}
		}

		if (currentLink.length) {
			var hyperlinkHref = currentLink[0].getAttribute('href');
			vdSetProperty('vdHyperlinkHref', hyperlinkHref);

			var hyperlinkTitle = currentLink[0].getAttribute('title');
			vdSetProperty('vdHyperlinkTitle', hyperlinkTitle);

			var hyperlinkName = currentLink[0].getAttribute('name');
			vdSetProperty('vdHyperlinkName', hyperlinkName);
			
			var hyperlinkNofollow = toolbar.querySelectorAll("button.vedor-hyperlink-nofollow");
			for (var i=0; i<hyperlinkNofollow.length; i++) {
				if (parent.getAttribute("rel") && parent.getAttribute("rel").match(/nofollow/)) {
					hyperlinkNofollow[i].classList.add("vedor-selected");
				} else {
					hyperlinkNofollow[i].classList.remove("vedor-selected");
				}
			}
		} else {
			vdSetProperty('vdHyperlinkHref', '');
			vdSetProperty('vdHyperlinkTitle', '');
			vdSetProperty('vdHyperlinkName', '');
			var hyperlinkNofollow = toolbar.querySelector("button.vedor-hyperlink-nofollow");
			if (hyperlinkNofollow) {
				hyperlinkNofollow.classList.remove("vedor-selected");
			}
		}

		if (parent || parent.getAttribute || parent.getAttribute("contenteditable")) {
			var parentStyles = editor.node.getAllStyles(parent);

			var textAlign = toolbar.querySelectorAll(".vedor-text-align[data-type=vedor-buttongroup-radio]");
			for (i=0; i<textAlign.length;i++) {
				switch (parentStyles["text-align"]) {
					case "right" :
						vdSetProperty(textAlign[i], "right");
					break;
					case "center" :
						vdSetProperty(textAlign[i], "center");
					break;
					case "justify" :
						vdSetProperty(textAlign[i], "justify");
					break;
					case "left" :
						vdSetProperty(textAlign[i], "left");
					break;
					default :
						vdSetProperty(textAlign[i], "left");
					break;
				}
			}

			// Set the parent icon for alignment as well;
			var currentIcon = toolbar.querySelectorAll("div.vedor-text-align button.vedor-selected i")[0];
			var icons = toolbar.querySelectorAll("button[data-vedor-section=vedor-text-align] i");
			for (i=0; i<icons.length; i++) {
				icons[i].className = currentIcon.className;
			}

			// Check "Bold"
			var textBold = toolbar.querySelectorAll(".vedor-text-bold button");
			for (i=0; i<textBold.length; i++) {
				if (parentStyles["font-weight"] == "bold") {
					textBold[i].classList.add("vedor-selected");
				} else {
					textBold[i].classList.remove("vedor-selected");
				}
			}

			// Check "Italic"
			var textItalic = toolbar.querySelectorAll(".vedor-text-italic button");
			for (i=0; i<textItalic.length; i++) {
				if (parentStyles["font-style"] == "italic") {
					textItalic[i].classList.add("vedor-selected");
				} else {
					textItalic[i].classList.remove("vedor-selected");
				}
			}

			// Check "Underline"
			var textUnderline = toolbar.querySelectorAll(".vedor-text-underline button");
			for (i=0; i<textUnderline.length; i++) {
				if (parentStyles["text-decoration"].match(/underline/)) {
					textUnderline[i].classList.add("vedor-selected");
				} else {
					textUnderline[i].classList.remove("vedor-selected");
				}
			}
		}
		return true;
	}		

	editor.addToolbar({
		"name" : "vedor-text-cursor",
		"filter" : {
			"sel-collapsed" : true
		},
		update : updateTextToolbar
	});

	editor.addToolbar({
		name : "vedor-text-selection",
		filter : {
			"sel-collapsed" : false
		},
		update : updateTextToolbar,
		actions : {
			'vedor-text-bold' : function() {
				editor.plugins.text.formatInline("Bold");
			},
			'vedor-text-italic' : function() {
				editor.plugins.text.formatInline("Italic");
			},
			'vedor-text-underline' : function() {
				editor.plugins.text.formatInline("Underline");
			},
			'vedor-text-align-left' : function() {
				editor.plugins.text.formatInline("JustifyLeft");
			},
			'vedor-text-align-right' : function() {
				editor.plugins.text.formatInline("JustifyRight");
			},
			'vedor-text-align-center' : function() {
				editor.plugins.text.formatInline("JustifyCenter");
			},
			'vedor-text-align-justify' : function() {
				editor.plugins.text.formatInline("JustifyFull");
			},
			'vedor-text-align-left' : function() {
				editor.plugins.text.formatInline("JustifyLeft");
			},
			'vedor-text-blockstyle' : function(value) {
				editor.plugins.text.formatBlock(value);
			},
			"vedor-hyperlink-href" : function(value) {
				if (!currentLink.length) {
					currentLink = editor.plugins.hyperlink.create();
				}
				editor.plugins.hyperlink.set(currentLink, {
					"href" : value,
					"title" : currentLink[0].getAttribute("title"),
					"name" : currentLink[0].getAttribute("name"),
					"rel" : currentLink[0].getAttribute("rel"),
					"class" : currentLink[0].getAttribute("class")
				});
			},
			"vedor-hyperlink-title" : function(value) {
				if (!currentLink.length) {
					currentLink = editor.plugins.hyperlink.create();
				}
				editor.plugins.hyperlink.set(currentLink, {
					"href" : currentLink[0].getAttribute("href"),
					"title" : value,
					"name" : currentLink[0].getAttribute("name"),
					"rel" : currentLink[0].getAttribute("rel"),
					"class" : currentLink[0].getAttribute("class")
				});
			},
			"vedor-hyperlink-name" : function(value) {
				if (!currentLink.length) {
					currentLink = editor.plugins.hyperlink.create();
				}
				editor.plugins.hyperlink.set(currentLink, {
					"href" : currentLink[0].getAttribute("href"),
					"title" : currentLink[0].getAttribute("title"),
					"name" : value,
					"rel" : currentLink[0].getAttribute("rel"),
					"class" : currentLink[0].getAttribute("class")
				});
			},
			"vedor-hyperlink-nofollow" : function(button) {
				if (!currentLink.length) {
					currentLink = editor.plugins.hyperlink.create();
				}
				if (currentLink[0].getAttribute("rel") == "nofollow") {
					editor.plugins.hyperlink.set(currentLink, {
						"href" : currentLink[0].getAttribute("href"),
						"title" : currentLink[0].getAttribute("title"),
						"name" : currentLink[0].getAttribute("name"),
						"class" : currentLink[0].getAttribute("class")
					});
					button.classList.remove("vedor-selected");
				} else {
					editor.plugins.hyperlink.set(currentLink, {
						"href" : currentLink[0].getAttribute("href"),
						"title" : currentLink[0].getAttribute("title"),
						"name" : currentLink[0].getAttribute("name"),
						"class" : currentLink[0].getAttribute("class"),
						"rel" : "nofollow"
					});
					button.classList.add("vedor-selected");
				}
			}
		}
	});
	editor.addContextFilter("vedor-hyperlink", {
		"selector" : "A",
		"parent" : {
			"selector" : "*"
		},
		"context" : "vedor-text-selection"
	});
</script>