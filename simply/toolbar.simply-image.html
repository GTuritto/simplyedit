<section id="simply-image" class="simply-section">
	<h1>HTML Image Toolbar</h1>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-section="simply-image-style" class="simply-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-simply-section="simply-image-align" class="simply-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-simply-section="simply-clipboard" class="simply-expands"><i class="fa fa-clipboard"></i>Clipboard</button></li>
			<li><button data-simply-section="simply-image-properties" class="simply-expands"><i class="fa fa-tags"></i>Properties</button></li>
			<li><button data-simply-section="simply-hyperlink" class="simply-expands"><i class="fa fa-link"></i>Link</button></li>
			<li><button data-simply-section="simply-code" data-simply-action="simply-edit-source"><i class="fa fa-code"></i>Code</button></li>
			<li><button data-simply-action="simply-hyperlink-follow"><i class="fa fa-external-link"></i>Follow link</button></li>
		</ul>
		<div class="simply-toolbar-section simply-image-style">
			<div>
				<label>Format</label><select id="vdImageType" data-simply-action=simply-image-type">
					<option value="">Original</option>
				</select>
			</div>
		</div>
		<div class="simply-toolbar-section simply-image-align" data-type="simply-buttongroup-radio" id="vdImageAlign">
		<ul>
			<li><button class="simply-align-left" data-value="left" data-simply-action="simply-image-align-left"><i class="fa fa-align-left"></i>Left</button></li>
			<li><button class="simply-align-right" data-value="right" data-simply-action="simply-image-align-right"><i class="fa fa-align-right"></i>Right</button></li>
			<li><button class="simply-align-top" data-value="top" data-simply-action="simply-image-align-top"><i class="fa fa-chevron-up"></i>Top</button></li>
			<li><button class="simply-align-bottom" data-value="bottom" data-simply-action="simply-image-align-bottom"><i class="fa fa-chevron-down"></i>Bottom</button></li>
			<li><button class="simply-align-middle" data-value="middle" data-simply-action="simply-image-align-middle"><i class="fa fa-chevron-right"></i>Middle</button></li>
			<li><button class="simply-align-none" data-value="none" data-simply-action="simply-image-align-none"><i class="fa fa-minus-circle"></i>None</button></li>
		</ul>
		</div>
		<div class="simply-toolbar-section simply-image-properties">
			<div><label>URL</label><input type="text" id="vdImageSrc" data-simply-action="simply-image-src"></div>
			<div><label>Alt</label><input type="text" id="vdImageAlt" data-simply-action="simply-image-alt"></div>
			<div><label>Title</label><input type="text" id="vdImageTitle" data-simply-action="simply-image-title"></div>
		</div>
		<div class="simply-toolbar-section simply-hyperlink">
			<div><label>URL</label><input type="text" id="vdHyperlinkHref" data-simply-action="simply-hyperlink-href"></div>
			<div><label>Title</label><input type="text" id="vdHyperlinkTitle" data-simply-action="simply-hyperlink-title"></div>
			<div><label>Name</label><input type="text" id="vdHyperlinkName" data-simply-action="simply-hyperlink-name"></div>
			<div><button class="simply-hyperlink-nofollow" data-simply-action="simply-hyperlink-nofollow"><i class="fa fa-chain-broken"></i>Nofollow</button></div>
		</div>
		<div class="simply-toolbar-section simply-clipboard">
			<ul>
				<li><button class="simply-clipboard-cut"><i class="fa fa-scissors"></i>Cut</button></li>
				<li><button class="simply-clipboard-copy"><i class="fa fa-files-o"></i>Copy</button></li>
				<li><button class="simply-clipboard-paste"><i class="fa fa-clipboard"></i>Paste</button></li>
			</ul>
		</div>
	</div>
</section>
<script type="text/javascript">
	var currentImage;
	var currentLink;

	editor.plugins.image = {
		placeholderData : null,
		placeholder : function() {
			if (!editor.plugins.image.placeholderData) {
				// Create a nice placeholder image and insert that;
				var canvas = document.createElement("canvas");
				canvas.setAttribute("height", 60);
				canvas.setAttribute("width", 80);

				var ctx = canvas.getContext("2d");
				ctx.fillStyle = "#ccc";
				ctx.fillRect(0,0,canvas.getAttribute("width"), canvas.getAttribute("height"));
				ctx.fillStyle = "#eee";
				ctx.fillRect(2,2,canvas.getAttribute("width")-4, canvas.getAttribute("height")-4);

				ctx.font = "48px FontAwesome";
				ctx.fillStyle = "#999";
				ctx.textAlign = "center";
				ctx.textBaseline = "middle";

				// Use FontAwesome 'photo' icon;
				ctx.fillText("\uf03e", canvas.getAttribute("width")/2, canvas.getAttribute("height")/2);
				
				editor.plugins.image.placeholderData = canvas.toDataURL("image/png");
			}
			return editor.plugins.image.placeholderData;
		},
		reselect : function() {
			var sel = window.getSelection();
			var image = sel.baseNode.nextSibling;
			if (!image) {
				image = sel.baseNode.parentNode.nextSibling;
			}
			if (image.nodeType == 1 && image.tagName.toLowerCase() == "img") {
				var range = document.createRange();
				range.setStartBefore(image);
				range.setEndAfter(image);

				sel.removeAllRanges();
				sel.addRange(range);
				vdSelection.selectNode(image);
			} else {
				sel.removeAllRanges();
			}
		}
	};

	editor.addToolbar({
		"name" : "simply-image",
		"filter" : {
			"selector" : "IMG",
			"parent" : {
				"selector" : "*"
			}
		},
		"update" : function(toolbar) {
			var sel = vdSelectionState.get();
			var image = vdSelection.getNode(sel);

			var imagePos = hopeEditor.selection.getTotalOffset(image);
			hopeEditor.selection.start = imagePos;
			hopeEditor.selection.end = imagePos+1;

			var range = hopeEditor.selection.getRange();
			hopeEditor.currentRange = range;

			var annotation = hopeEditor.fragment.has(range, "img");
			
			var type=image.getAttribute('data-simply-image-type');
			if (!type || type=='undefined') {
				// type='Origineel'; // FIXME: gewoon de eerste in de lijst selecteren?
				type = document.querySelectorAll("#vdImageType option")[0].value;
			}
			simply.widgets.properties.set('vdImageType',type);

			var alt=image.getAttribute('alt');
			simply.widgets.properties.set('vdImageAlt',alt);

			var alignOptions = ["left", "right", "top", "middle", "bottom"];
			for (var i=0; i<alignOptions.length; i++) {
				if (image.classList.contains("simply-image-align-" + alignOptions[i])) {
					simply.widgets.properties.set('vdImageAlign', alignOptions[i]);
				}
			}

			var title=image.getAttribute('title');
			simply.widgets.properties.set('vdImageTitle', title);

			var src=image.getAttribute('src');
			if (src == editor.plugins.image.placeholder()) {
				src = "";
			}
			simply.widgets.properties.set('vdImageSrc', src);

			var hyperlink = hopeEditor.fragment.has(range, "a");

			toolbar.querySelector("button[data-simply-action=simply-hyperlink-follow]").parentNode.style.display = "none";
			if (hyperlink) {
				toolbar.querySelector("button[data-simply-action=simply-hyperlink-follow]").parentNode.style.display = "block";
				var linkNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
				var hyperlinkHref = linkNode.getAttribute('href');
				simply.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), hyperlinkHref);

				var hyperlinkTitle = linkNode.getAttribute('title');
				simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), hyperlinkTitle);

				var hyperlinkName = linkNode.getAttribute('name');
				simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), hyperlinkName);
				
				var hyperlinkNofollow = toolbar.querySelector("button.simply-hyperlink-nofollow");
				if (linkNode.getAttribute("rel") && linkNode.getAttribute("rel").match(/nofollow/)) {
					hyperlinkNofollow.classList.add("simply-selected");
				} else {
					hyperlinkNofollow.classList.remove("simply-selected");
				}
			} else {
				simply.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), '');
				simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), '');
				simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), '');
				
				var hyperlinkNofollow = toolbar.querySelector("button.simply-hyperlink-nofollow");
				if (hyperlinkNofollow) {
					hyperlinkNofollow.classList.remove("simply-selected");
				}
			}

			// Set the parent icon for alignment as well;
			var currentIcon = document.querySelector("div.simply-image-align button.simply-selected i");
			if (currentIcon) {
				var icons = document.querySelectorAll("button[data-simply-section=simply-image-align] i");
				for (var i=0; i<icons.length; i++) {
					icons[i].className = currentIcon.className;
				}
			}
		},
		"init" : function() {
			vdSetImage = function() {
				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, "img");

				var type=vdGetProperty('vdImageType');
				var align=vdGetProperty('vdImageAlign');

				if (annotation) {
					var tempNode = editor.plugins.hope.annotation.explode(annotation.tag);

					if (type) {
						tempNode.setAttribute('data-simply-image-type',type);
					} else {
						tempNode.removeAttribute('data-simply-image-type');
					}

					tempNode.classList.remove("simply-image-align-left");
					tempNode.classList.remove("simply-image-align-right");
					tempNode.classList.remove("simply-image-align-top");
					tempNode.classList.remove("simply-image-align-bottom");
					tempNode.classList.remove("simply-image-align-middle");

					switch (align) {
						case 'left':
						case 'right':
						case 'top':
						case 'bottom':
						case 'middle':
							tempNode.classList.add("simply-image-align-" + align);
						break;
					}

					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, editor.plugins.hope.annotation.implode(tempNode));
					hopeEditor.update();
					editor.plugins.image.reselect();
					vdStoreUndo();
				} else if (hopeEditor.field.tagName.toLowerCase() === "img") {
					if (type) {
						hopeEditor.field.setAttribute('data-simply-image-type',type);
					} else {
						hopeEditor.field.removeAttribute('data-simply-image-type');
					}
					hopeEditor.field.classList.remove("simply-image-align-left");
					hopeEditor.field.classList.remove("simply-image-align-right");
					hopeEditor.field.classList.remove("simply-image-align-top");
					hopeEditor.field.classList.remove("simply-image-align-bottom");
					hopeEditor.field.classList.remove("simply-image-align-middle");

					switch (align) {
						case 'left':
						case 'right':
						case 'top':
						case 'bottom':
						case 'middle':
							hopeEditor.field.classList.add("simply-image-align-" + align);
						break;
					}
					
				}
			};


			// Disable user zoom, because it will zoom extremely weird when you select an image on android devices;
			var viewportMeta = document.head.querySelector("meta[name=viewport]");
			if (!viewportMeta) {
				viewportMeta = document.createElement("meta");
				viewportMeta.setAttribute("name", "viewport");
				viewportMeta.setAttribute("content", "user-scalable=no");
				document.head.appendChild(viewportMeta);
			} else {
				viewportMeta.setAttribute("content", viewportMeta.getAttribute("content") + ", user-scalable=no");
			}
		},
		"actions" : {
			"simply-image-align-left" : function() {
				simply.widgets.properties.set("vdImageAlign", "left");
				vdSetImage();
			},
			"simply-image-align-right" : function() {
				simply.widgets.properties.set("vdImageAlign", "right");
				vdSetImage();
			},
			"simply-image-align-top" : function() {
				simply.widgets.properties.set("vdImageAlign", "top");
				vdSetImage();
			},
			"simply-image-align-middle" : function() {
				simply.widgets.properties.set("vdImageAlign", "middle");
				vdSetImage();
			},
			"simply-image-align-bottom" : function() {
				simply.widgets.properties.set("vdImageAlign", "bottom");
				vdSetImage();
			},
			"simply-image-align-none" : function() {
				simply.widgets.properties.set("vdImageAlign", "none");
				vdSetImage();
			},
			"simply-image-type" : function() {
				vdSetImage();
			},
			"simply-image-delete" : function() {
				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, "img");

				if (annotation) {
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					hopeEditor.update();
				}
			},
			"simply-image-alt" : function(value) {
				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, "img");
				if (annotation) {
					var tempNode = editor.plugins.hope.annotation.explode(annotation.tag);
					if (value) {
						tempNode.setAttribute("alt", value);
					} else {
						tempNode.removeAttribute("alt");
					}
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, editor.plugins.hope.annotation.implode(tempNode));
					hopeEditor.update();
					editor.plugins.image.reselect();
				} else if (hopeEditor.field.tagName.toLowerCase() === "img") {
					if (value) {
						hopeEditor.field.setAttribute("alt", value);
					} else {
						hopeEditor.field.removeAttribute("alt");
					}
				}
			},
			"simply-image-title" : function(value) {
				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, "img");
				if (annotation) {
					var tempNode = editor.plugins.hope.annotation.explode(annotation.tag);
					if (value) {
						tempNode.setAttribute("title", value);
					} else {
						tempNode.removeAttribute("title");
					}
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, editor.plugins.hope.annotation.implode(tempNode));
					hopeEditor.update();
					editor.plugins.image.reselect();
				} else if (hopeEditor.field.tagName.toLowerCase() === "img") {
					if (value) {
						hopeEditor.field.setAttribute("title", value);
					} else {
						hopeEditor.field.removeAttribute("title");
					}
				}
			},
			"simply-image-src" : function(value) {
				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, "img");
				if (annotation) {
					var tempNode = editor.plugins.hope.annotation.explode(annotation.tag);
					if (value) {
						tempNode.setAttribute("src", value);
					} else {
						tempNode.setAttribute("src", editor.plugins.image.placeholder());
					}
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, editor.plugins.hope.annotation.implode(tempNode));
					hopeEditor.update();
					editor.plugins.image.reselect();
				} else if (hopeEditor.field.tagName.toLowerCase() === "img") {
					if (value) {
						hopeEditor.field.setAttribute("src", value);
					} else {
						hopeEditor.field.setAttribute("src", editor.plugins.image.placeholder());
					}
				}
			},
			"simply-insert-image" : function() {
				var imageSrc = editor.plugins.image.placeholder();
				var range = hopeEditor.currentRange;

				var imageFragment = hope.fragment.create("\u00AD", '0-1:img src="' + imageSrc + '"');
				hopeEditor.fragment = hopeEditor.fragment.insert(range.start, imageFragment);

				range = hope.range.create(range.start, range.start+1);

				hopeEditor.fragment = hopeEditor.fragment.apply(range, 'img src="' + imageSrc + '"');
				hopeEditor.update();
				editor.plugins.image.reselect();
			}
		}
	});
</script>