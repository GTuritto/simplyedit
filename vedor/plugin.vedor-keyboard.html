<script type="text/javascript">
	var documentHandler = function(event) {
		var key = event.keyCode || event.which;

		if (key == 66 && event.ctrlKey) { // Ctrl-B
			if (typeof editor.actions["vedor-text-bold"] === "function") {
				editor.toolbar.beforeAction();
				editor.actions["vedor-text-bold"]();
				event.preventDefault();
			}
		} else if (key == 27) { // ESC
			editor.context.toolbar.hide = true;
			editor.context.update();
			event.preventDefault();
		} else if (key == 73 && event.ctrlKey) { // Ctrl-I
			if (typeof editor.actions["vedor-text-italic"] === "function") {
				editor.toolbar.beforeAction();
				editor.actions["vedor-text-italic"]();
				event.preventDefault();
			}
		} else if (key == 85 && event.ctrlKey) { // Ctrl-U
			if (typeof editor.actions["vedor-text-underline"] === "function") {
				editor.toolbar.beforeAction();
				editor.actions["vedor-text-underline"]();
				event.preventDefault();
			}
		} else if (key == 83 && event.ctrlKey) { // Ctrl-S
			if (typeof editor.actions["vedor-save"] === "function") {
				editor.toolbar.beforeAction();
				editor.actions["vedor-save"]();
				event.preventDefault();
			}
		} else if (key == 32 && event.ctrlKey) { // Ctrl-space
			editor.context.toolbar.hide = false;
			editor.context.update();
			var activeToolbar = document.querySelector(".vedor-section.active");
			if (activeToolbar) {
				var firstButton = activeToolbar.querySelector("button");
				if (firstButton) {
					firstButton.focus();
				}
			}

			var toolbarTarget = document.querySelector(".vedor-section.active .vedor-buttons > li");
			
			if (toolbarTarget) {
				toolbarTarget.focus();
			}
			event.preventDefault();
		} else if (key == 77 && event.ctrlKey) { // Ctrl-M
			document.querySelector("#vedor-main-toolbar button").focus();
			event.preventDefault();
		} else if (key == 37) { // left
			var target = this.querySelector(".vedor-section.active button:focus, .vedor-section.active select:focus, #vedor-main-toolbar :focus"); 
			if (target) {
				var previousSibling = target.parentNode.previousSibling;
				while (previousSibling) {
					if (previousSibling.nodeType == 1) {
						if (
							previousSibling.childNodes[0] && 
							previousSibling.offsetWidth > 0 
						) {
							break;
						}
					}
					previousSibling = previousSibling.previousSibling;
				}

				if (previousSibling) {
					previousSibling.querySelector("*").focus();
				}
				event.preventDefault();
			}
		} else if (key == 38) { // up
			// close current toolbar section;
			var targets = this.querySelectorAll('.vedor-section.active .vedor-selected');
			if (targets.length) {
				for (var i=0; i<targets.length; i++) {
					targets[i].classList.remove("vedor-selected");
				}
				targets[0].focus();
				event.preventDefault();
			}
		} else if (key == 39) { // right
			var target = this.querySelector(".vedor-section.active button:focus, .vedor-section.active select:focus, #vedor-main-toolbar :focus"); 
			if (target) {
				var nextSibling = target.parentNode.nextSibling;
				while (nextSibling) {
					if (nextSibling.nodeType == 1) {
						if (nextSibling.childNodes[0] && nextSibling.offsetWidth > 0) {
							break;
						}
					}
					nextSibling = nextSibling.nextSibling;
				}

				if (nextSibling) {
					nextSibling.querySelector("*").focus();
				}
				event.preventDefault();
			}
		} else if (key == 40) { // down
			// open current toolbar section;
			var target = this.querySelector('.vedor-section.active :focus');
			if (target) {
				if (target.classList.contains("vedor-expands")) {
					if (target.classList.contains("vedor-selected")) {
						muze.event.fire(target, "click");
					}
					muze.event.fire(target, "click");
				}
				event.preventDefault();
			}
		} else {
			var target = this.querySelector('.vedor-section.active :focus');
			if (!target) {
				editor.context.toolbar.hide = true;
			}
		}
	};

	editor.addToolbar({
		name : 'vedor-keyboard-handler',
		init : function() {
			document.addEventListener("keydown", documentHandler);
		}
	});
</script>