<script>
	(function() {
		var removeMouseSelectionEvent;
		var removeTouchSelectionEvent;
	
		var selectTarget = function(target) {
			var sel = vdSelectionState.get();
			sel.selectNode(target);
			sel.startContainer.ownerDocument.defaultView.getSelection().removeAllRanges();
			sel.startContainer.ownerDocument.defaultView.getSelection().addRange(sel);
			vdSelectionState.save(sel);
			sel.startContainer.ownerDocument.defaultView.getSelection().removeAllRanges()
			editor.context.update();
		};

		var handleItemFocus = function(event) {
			var target = muze.event.target(event);
			if (target.getAttribute("contenteditable")) {
				return;
			}
			selectTarget(target);
		};

		var handleItemSelect = function(event) {
			if (!this.clickStart) {
				return;
			}
			var deltaX = Math.abs(event.clientX - this.clickStart.x);
			var deltaY = Math.abs(event.clientY - this.clickStart.y);
			var deltaTime = Math.abs((new Date()).getTime() - this.clickStart.time);

			if (deltaTime > 1000) { // if the click took more than one second, or...
				return;
			} else {
				if (deltaX > 40 || deltaY > 40) { // the pointer moved a lot to get this click, it probably wasn't to select the item.
					return;
				}
			}

			var target = muze.event.target(event);
			if (target.getAttribute("contenteditable")) {
				return;
			}

			while(!target.getAttribute("data-simply-selectable") && target.parentNode) {
				if (target.getAttribute("contenteditable")) {
					return;
				}
			
				target = target.parentNode;
			}

			selectTarget(target);
		
			window.setTimeout(function() {
				removeMouseSelectionEvent = muze.event.attach(document, "mousedown", function(evt) {
					var target = muze.event.target(evt);
					// Keep the selection when the click is within a toolbar;
					if (editor.node.hasToolbarParent(target)) {
						return;
					}

					if (document.querySelector(":focus") &&
						editor.node.hasToolbarParent(document.querySelector(":focus"))) {
						return;
					}

					muze.event.detach(document, "mousedown", removeMouseSelectionEvent);
					muze.event.detach(document, "touchstart", removeTouchSelectionEvent);
					vdSelectionState.remove();
				});
				removeTouchSelectionEvent = muze.event.attach(document, "touchstart", function(evt) {
					var target = muze.event.target(evt);
					// Keep the selection when the click is within a toolbar;
					if (editor.node.hasToolbarParent(target)) {
						return;
					}

					if (document.querySelector(":focus") &&
						editor.node.hasToolbarParent(document.querySelector(":focus"))) {
						return;
					}

					muze.event.detach(document, "mousedown", removeMouseSelectionEvent);
					muze.event.detach(document, "touchstart", removeTouchSelectionEvent);
					vdSelectionState.remove();
				});
			}, 50);
		}
	
		var bindSelectables = function() {
			var listItems = document.querySelectorAll("[data-simply-selectable]");
			for (var i=0; i<listItems.length; i++) {
				listItems[i].removeEventListener('click', handleItemSelect);
				listItems[i].removeEventListener('focus', handleItemFocus);
				if (!listItems[i].getAttribute("tabindex")) {
					listItems[i].setAttribute("tabindex", 0);
				}
				listItems[i].addEventListener('click', handleItemSelect);
				listItems[i].addEventListener('focus', handleItemFocus);
				listItems[i].addEventListener('mousedown', function(evt) {
					var target = this;
					target.clickStart = {
						x : evt.clientX,
						y : evt.clientY,
						time : (new Date()).getTime()
					};
				});
			}
		}
		
		document.addEventListener("simply-selectable-inserted", bindSelectables);

		editor.addToolbar({
			name: 'simply-selectable',
			init : bindSelectables
		});
	})();
</script>