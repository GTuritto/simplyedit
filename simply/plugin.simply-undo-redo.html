<script type="text/javascript">
	editor.plugins.undoRedo = {
		currentUndo : -1,
		undoSet : [],
		isEqual : function(data1, data2) {
			if (typeof data1 === "undefined" || typeof data2 === "undefined") {
				return false;
			}
			if (JSON.stringify(data1) == JSON.stringify(data2)) {
				return true;
			}
			return false;
		},
		storeUndo : function() {
			if (editor.plugins.undoRedo.undoing) {
				return;
			}
			var currentData = JSON.stringify(editor.currentData);
			if (!editor.plugins.undoRedo.isEqual(editor.plugins.undoRedo.previousData, currentData)) {
				editor.plugins.undoRedo.undoSet.splice(editor.plugins.undoRedo.currentUndo + 1);
				editor.plugins.undoRedo.undoSet.push(currentData);
				editor.plugins.undoRedo.previousData = currentData;
				editor.plugins.undoRedo.currentUndo++;
			}
			editor.toolbars["simply-undo-redo"].update();
		},
		undo : function() {
			if (!editor.plugins.undoRedo.canUndo) {
				return;
			}
			editor.plugins.undoRedo.undoing = true;
			editor.context.toolbar.hide = true;
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo - 1];
			if (typeof undoStep !== "undefined") {
				if (editor.plugins.undoRedo.currentUndo == editor.plugins.undoRedo.undoSet.length-1) { 
					editor.plugins.undoRedo.storeUndo();
				}
				var currentScroll = document.body.scrollTop; // removing the items will reset the scrolloffset;
				editor.currentData = JSON.parse(undoStep);

				editor.data.apply(editor.currentData, document);
				editor.plugins.undoRedo.previousData = undoStep;
				document.body.scrollTop = currentScroll;
				editor.plugins.undoRedo.currentUndo--;
			}
			editor.toolbars["simply-undo-redo"].update();
			window.setTimeout(function() {
				editor.plugins.undoRedo.undoing = false;
				editor.toolbars["simply-undo-redo"].update();
			}, 200);
		},
		redo : function() {
			if (!editor.plugins.undoRedo.canRedo) {
				return;
			}
			editor.plugins.undoRedo.undoing = true;
			editor.context.toolbar.hide = true;
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo + 1];
			if (typeof undoStep !== "undefined") {
				var currentScroll = document.body.scrollTop; // removing the items will reset the scrolloffset;
				editor.currentData = JSON.parse(undoStep);
				editor.data.apply(editor.currentData, document);
				editor.plugins.undoRedo.previousData = undoStep;
				document.body.scrollTop = currentScroll;
				editor.plugins.undoRedo.currentUndo++;
			}
			editor.toolbars["simply-undo-redo"].update();
			window.setTimeout(function() {
				editor.plugins.undoRedo.undoing = false;
				editor.toolbars["simply-undo-redo"].update();
			}, 200);
		},
		canUndo : function() {
			if (editor.plugins.undoRedo.undoing) {
				return false;
			}
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo - 1];
                        if (typeof undoStep !== "undefined") {
				return true;
			}
			return false;
		},
		canRedo : function() {
			if (editor.plugins.undoRedo.undoing) {
				return false;
			}
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo + 1];
			if (typeof undoStep !== "undefined") {
				return true;
			}
			return false;
		},
		changeHandler : function(evt) {
			if (!editor.plugins.undoRedo.undoing) {
				editor.plugins.undoRedo.storeUndo();
				this.undoSaved = false;
			}
		}
	};

	editor.addToolbar({
		name : 'simply-undo-redo',
		init : function() {
			var listItem = document.createElement("li");
			var button = document.createElement("button");
			button.dataset.simplyAction = "simply-undo";
			button.innerHTML = '<i class="fa fa-undo"></i>Undo';
			listItem.appendChild(button);
			document.querySelector("#simply-main-toolbar .simply-buttons").appendChild(listItem);

			listItem = document.createElement("li");
			button = document.createElement("button");
			button.dataset.simplyAction = "simply-redo";
			button.innerHTML = '<i class="fa fa-repeat"></i>Redo';
			listItem.appendChild(button);
			document.querySelector("#simply-main-toolbar .simply-buttons").appendChild(listItem);

			document.addEventListener("simply-data-changed", editor.plugins.undoRedo.changeHandler);
			editor.plugins.undoRedo.storeUndo();
		},
		update : function() {
			var undoButton = document.querySelector("#simply-main-toolbar [data-simply-action=simply-undo]");
			var redoButton = document.querySelector("#simply-main-toolbar [data-simply-action=simply-redo]");

			if (editor.plugins.undoRedo.canUndo()) {
				if (undoButton.getAttribute("disabled")) {
					undoButton.removeAttribute("disabled");
				}
			} else {
				if (!undoButton.getAttribute("disabled")) {
					undoButton.setAttribute("disabled", true);
				}
			}

			if (editor.plugins.undoRedo.canRedo()) {
				if (redoButton.getAttribute("disabled")) {
					redoButton.removeAttribute("disabled");
				}
			} else {
				if (!redoButton.getAttribute("disabled")) {
					redoButton.setAttribute("disabled", true);
				}
			}
		},
		actions : {
			"simply-undo" : function() {
				editor.plugins.undoRedo.undo();
				editor.toolbars["simply-undo-redo"].update();
			},
			"simply-redo" : function() {
				editor.plugins.undoRedo.redo();
				editor.toolbars["simply-undo-redo"].update();
			}
		}
	});
</script>