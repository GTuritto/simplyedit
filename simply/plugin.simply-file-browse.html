<section id="simply-file-browse" class="simply-dialog simply-modal">
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-file-browse-add-page"><i class="fa fa-file-text-o"></i>Add page</button></li>
			<li><button data-simply-action="simply-file-browse-add-folder"><i class="fa fa-plus-square"></i>Add folder</button></li>
			<li><button data-simply-action="simply-file-browse-upload"><i class="fa fa-upload"></i>Upload</button><input type="file" multiple></li>
			<li><button data-simply-action="simply-file-browse-delete"><i class="fa fa-trash"></i>Delete</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-close"><i class="fa fa-times"></i>Cancel</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-fullscreen"><i class="fa fa-expand"></i>Full screen</button></li>
		</ul>
	</div>
	<div class="simply-dialog-body">
	</div>
</section>
<style type="text/css">
	#simply-file-browse .simply-dialog-body > button,
	#simply-file-browse .simply-dialog-body > .simply-button,
	#simply-file-browse .simply-add-folder,
	#simply-file-browse .simply-add-page {
		border: 1px solid #eee;
		background-color: white;
		height: 149px;
		width: 149px;
		font-family: inherit;
		font-size: 20px;
		position: relative;
		padding: 5px;
		color: #999 !important;
		display: inline-block;
		vertical-align: top;
		text-align: center;
		box-sizing: border-box;
		padding-top: 30px;
	}
	#simply-file-browse .simply-add-folder,
	#simply-file-browse .simply-add-page {
		box-sizing: border-box;
		padding-top: 38px;
	}

	#simply-file-browse .simply-add-folder input,
	#simply-file-browse .simply-add-page input {
		width: 133px;
		color: #333;
	}
	#simply-file-browse input[type="file"] {
		display: none;
	}
	#simply-file-browse .simply-dialog-body > button:before,
	#simply-file-browse .simply-dialog-body > .simply-button:before {
		display: block;
		content: '';
		position: absolute;
		top: 0px;
		left: 0px;
		height: 100%;
		width: 100%;
	}
        #simply-file-browse .simply-dialog-body > button i,
        #simply-file-browse .simply-dialog-body > .simply-button i,
	#simply-file-browse .simply-add-folder > i,
	#simply-file-browse .simply-add-page > i {
		font-size: 48px;
		display: block;
		width: 100%;
		text-align: center;
	}
	#simply-file-browse .simply-add-folder > button.simply-add,
	#simply-file-browse .simply-add-page > button.simply-add {
		color: #333;
		background-color: #eee;
		position: absolute;
		bottom: 5px;
		left: 5px;
		padding: 3px 10px 3px 6px;
		border: 1px solid #999
	}
	#simply-file-browse .simply-add-folder > button.simply-cancel,
	#simply-file-browse .simply-add-page > button.simply-cancel {
		color: #666;
		position: absolute;
		bottom: 5px;
		right: 5px;
		border: 0px;
		background-color: white;
		font-size: 18px;
	}
	#simply-file-browse .simply-add-folder > button.simply-add > i,
	#simply-file-browse .simply-add-page > button.simply-add > i {
		margin-right: 5px;
	}

	#simply-file-browse .simply-dialog-body > button img,
	#simply-file-browse .simply-dialog-body > .simply-button img {
		max-width: 100%;
		max-height: 100%;
	}
	#simply-file-browse .simply-dialog-body > button progress,
	#simply-file-browse .simply-dialog-body > .simply-button progress {
		width: 100%;
		height: 10px;
	}
	#simply-file-browse .simply-dialog-body > button i.select,
	#simply-file-browse .simply-dialog-body > .simply-button i.select {
		position: absolute;
		top: 0;
		right: 0px;
		display: inline-block;
		text-align: right;
		width: 40px;
	}
	#simply-file-browse .simply-dialog-body > button i.select:before,
	#simply-file-browse .simply-dialog-body > .simply-button i.select:before {
		width: 16px;
		display: inline-block;
		font-size: 20px;
		border-left: 1px solid #ddd;
		padding: 10px;
		border-bottom: 1px solid #ddd;
		color: #ddd;
		border-bottom-left-radius: 15px;
		z-index: 1;
		background-color: rgba(255,255,255,0.3);
		vertical-align: top;
		box-sizing: content-box;
	}
	#simply-file-browse .simply-dialog-body.simply-selecting button i.select,
	#simply-file-browse .simply-dialog-body.simply-selecting .simply-button i.select {
		position: absolute;
		top: 0px;
		left: 0px;
		bottom: 0px;
		right: 0px;
		width: auto;
	}
	#simply-file-browse .simply-dialog-body > button.simply-selected i.select:before,
	#simply-file-browse .simply-dialog-body > .simply-button.simply-selected i.select:before {
		border-color: #999;
		color: #16B916;
		background-color: rgba(255,255,255,0.8);
	}

	@media (max-width: 481px) {
		#simply-file-browse .simply-dialog-body > button,
		#simply-file-browse .simply-dialog-body > .simply-button {
			width: 50%;
		}
		#simply-file-browse .simply-dialog-body > .simply-add-folder,
		#simply-file-browse .simply-dialog-body > .simply-add-page {
			width: 50%;
		}
	}
</style>
<script>
	editor.plugins.fileBrowse = {
		currentSel : null,
		currentField : null,
		currentJail : null,
		path : null,
		dialog : {
			open : function() {
				editor.plugins.fileBrowse.currentSel = vdSelectionState.get();
				editor.plugins.fileBrowse.currentField = editor.node.getEditableField();
				editor.plugins.fileBrowse.currentJail = null;

				vdSelectionState.save(editor.plugins.fileBrowse.currentSel);
				editor.plugins.dialog.open(document.getElementById('simply-file-browse'), editor.plugins.fileBrowse.dialog.update);
			},
			loadFiles : function(url) {
				var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");
				var parser = document.createElement("A");
				parser.href = url;
				if (editor.plugins.fileBrowse.currentJail === null) {
					editor.plugins.fileBrowse.currentJail = parser.href;
				}
				editor.plugins.fileBrowse.currentPath = parser.href;

				editor.storage.list(url, function(fileData) {
					var i;
					var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");
					var newHtml = '';
					for (i=0; i<fileData.folders.length; i++) {
						if (fileData.folders[i].url.indexOf(editor.plugins.fileBrowse.currentJail) === 0) {
							newHtml += "<div class='simply-button' data-simply-action='simply-file-browse-directory' data-value='" + fileData.folders[i].url + "'><i class='select fa fa-check'></i><i class='fa fa-folder'></i>" + fileData.folders[i].name + "</div>";
						}
					}
					for (i=0; i<fileData.files.length; i++) {
						if (fileData.files[i].url.indexOf(editor.plugins.fileBrowse.currentJail) === 0) {
							newHtml += "<div class='simply-button' data-simply-action='simply-file-browse-insert' data-value='" + fileData.files[i].url + "'><i class='select fa fa-check'></i><i class='fa fa-file-text-o'></i>" + fileData.files[i].name + "</div>";
						}
					}
					targetList.innerHTML = newHtml;
					targetList.scrollTop = 0;

					var selectors = targetList.querySelectorAll("i.select");
					for (i=0; i<selectors.length; i++) {
						selectors[i].addEventListener("click", function(evt) {
							this.parentNode.classList.toggle("simply-selected");
							evt.preventDefault();
							evt.stopPropagation();
							editor.plugins.fileBrowse.dialog.updateToolbar();
						});
					}
				});
			},
			update : function() {
				// var parent = vdSelection.getNode(editor.plugins.fileBrowse.currentSel);
				editor.plugins.fileBrowse.dialog.loadFiles(editor.plugins.fileBrowse.path);
			},
			updateToolbar : function() {
				window.setTimeout(function() {
					var targetList = document.querySelectorAll("#simply-file-browse .simply-dialog-body .simply-selected");
					var uploadButton = document.querySelector("#simply-file-browse li [data-simply-action='simply-file-browse-upload']");
					var addPageButton = document.querySelector("#simply-file-browse li [data-simply-action='simply-file-browse-add-page']");
					var addFolderButton = document.querySelector("#simply-file-browse li [data-simply-action='simply-file-browse-add-folder']");
					var deleteButton = document.querySelector("#simply-file-browse li [data-simply-action='simply-file-browse-delete']");

					if (targetList.length === 0) {
						document.querySelector("#simply-file-browse .simply-dialog-body").classList.remove("simply-selecting");
						if (uploadButton) {
							uploadButton.parentNode.style.display = "block";
						}
						if (addPageButton) {
							addPageButton.parentNode.style.display = "block";
						}
						if (addFolderButton) {
							addFolderButton.parentNode.style.display = "block";
						}
						if (deleteButton) {
							deleteButton.parentNode.style.display = "none";
						}
					} else {
						document.querySelector("#simply-file-browse .simply-dialog-body").classList.add("simply-selecting");
						if (uploadButton) {
							uploadButton.parentNode.style.display = "none";
						}
						if (addPageButton) {
							addPageButton.parentNode.style.display = "none";
						}
						if (addFolderButton) {
							addFolderButton.parentNode.style.display = "none";
						}
						if (deleteButton) {
							deleteButton.parentNode.style.display = "block";
						}
					}

					if (editor.plugins.fileBrowse.currentPath && (editor.plugins.fileBrowse.currentPath.indexOf("data.json") > -1)) {
						// In data.json browsing mode; disable upload button;
						if (uploadButton) {
							uploadButton.parentNode.style.display = "none";
						}
					} else {
						if (addPageButton) {
							addPageButton.parentNode.style.display = "none";
						}
					}
				}, 50);
			}

		},
		init : function() {
			var listItem = document.createElement("LI");
			var button = document.createElement("button");
			button.dataset.simplyAction = "simply-file-browse-sitemap";
			button.innerHTML = '<i class="fa fa-sitemap"></i>Sitemap';
			listItem.appendChild(button);
			document.querySelector("#simply-main-toolbar .simply-buttons").appendChild(listItem);

			editor.plugins.fileBrowse.path = editor.storage.endpoint;

			var target = document.querySelectorAll('[data-simply-action="simply-hyperlink-href"]');
			if (target) {
				for (var i=0; i<target.length; i++) {
					var button = document.createElement("div");
					button.innerHTML = '<button data-simply-action="simply-file-browse"><i class="fa fa-folder"></i></button>';
					target[i].parentNode.querySelector("label").appendChild(button.firstChild);
				}
			} else {
				window.setTimeout(editor.plugins.fileBrowse.init, 200);
			}

			if (editor.storage.file && typeof editor.storage.file.save === "function") {
				document.querySelector("#simply-file-browse").addEventListener("drop", function(evt) {
					evt.preventDefault();
					editor.plugins.fileBrowse.handleFiles(evt.dataTransfer.files);
				});
				document.querySelector("#simply-file-browse input[type='file']").addEventListener("change", function(evt) {
					editor.plugins.fileBrowse.handleFiles(this.files);
				});
			} else {
				var uploadButton = document.querySelector('[data-simply-action="simply-file-browse-upload"]');
				uploadButton.parentNode.parentNode.removeChild(uploadButton.parentNode);

				var addButton = document.querySelector('[data-simply-action="simply-file-browse-add-folder"]');
				addButton.parentNode.parentNode.removeChild(addButton.parentNode);
			}

			if (editor.storage.file && typeof editor.storage.file.delete === "function") {
				// Do nothing;
			} else {
				var deleteButton = document.querySelector('[data-simply-action="simply-file-browse-delete"]');
				deleteButton.parentNode.parentNode.removeChild(deleteButton.parentNode);
			}

			document.querySelector("#simply-file-browse").addEventListener("DOMNodeInserted", editor.plugins.fileBrowse.dialog.updateToolbar);
			document.querySelector("#simply-file-browse").addEventListener("DOMNodeRemoved",editor.plugins.fileBrowse.dialog.updateToolbar);

			var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");
			new Slip(targetList); // slip is used for the tap-hold timing;
			targetList.addEventListener("slip:beforereorder", function(evt) {
				var targetButton = evt.target;
				if (targetButton.tagName.toLowerCase() == "i") {
					targetButton = targetButton.parentNode;
				}
				targetButton.classList.toggle("simply-selected");
				editor.plugins.fileBrowse.dialog.updateToolbar();

				targetButton.addEventListener("click", editor.plugins.fileBrowse.cancelClick, true);
				targetButton.addEventListener("mouseup", function(evt) {
					var currentButton = this;
					window.setTimeout(function() {
						currentButton.removeEventListener("click", editor.plugins.fileBrowse.cancelClick, true);
					}, 50);
				});
				evt.preventDefault();
				evt.stopPropagation();
			});
		},
		cancelClick : function(evt) {
			evt.preventDefault();
			evt.stopPropagation();
		},
		handleFiles : function(files) {
			if (files.length) {
				for (var i=0; i<files.length; i++) {
					var subpath = editor.plugins.fileBrowse.currentPath.replace(editor.storage.endpoint, "");
					var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");

					var newButton = document.createElement("BUTTON");
					newButton.setAttribute("data-simply-action", "simply-file-uploading");
					newButton.innerHTML = "Uploading<br><progress value=0 max=100></progress><br>" + files[i].name;
					targetList.appendChild(newButton);
					newButton.querySelector("progress").setAttribute("data-simply-progress", subpath + files[i].name);

					var url = editor.plugins.fileBrowse.currentPath + files[i].name.replace(/[^A-Za-z0-9_\.-]/, "-");

					(function(targetButton, url, name) {
						editor.storage.file.save(subpath + files[i].name, files[i], function() {
							targetButton.innerHTML = "<i class='select fa fa-check'></i><i class='fa fa-file-text-o'></i>" + name;
							targetButton.setAttribute("data-simply-action", "simply-file-browse-insert");
							targetButton.setAttribute("data-value", url);
						});
					}(newButton, url, files[i].name));
				}
			}
		}
	};

	editor.addAction("simply-file-browse", function(el) {
		editor.actions["simply-file-browse-insert"] = function(button) {
			vdSelectionState.restore(editor.plugins.fileBrowse.currentSel);
			hopeEditor.selection.updateRange();

			window.setTimeout(function() {
				var targetUrl = button.getAttribute("data-value");
				if (editor.storage.dataEndpoint && targetUrl.indexOf(editor.storage.dataEndpoint) === 0) {
					targetUrl = targetUrl.replace(editor.storage.dataEndpoint, '');
				}

				el.parentNode.parentNode.querySelector("input").value = targetUrl;
				muze.event.fire(el.parentNode.parentNode.querySelector("input"), "change");
				editor.plugins.dialog.close();
			}, 0);
		};
		editor.plugins.fileBrowse.path = editor.storage.endpoint;
		editor.plugins.fileBrowse.dialog.open();
	});
	editor.addAction("simply-file-browse-sitemap", function(el) {
		editor.actions["simply-file-browse-insert"] = function(button) {
			var target = button.getAttribute("data-value");
			if (editor.storage.dataEndpoint) {
				target = target.replace(editor.storage.dataEndpoint, "");
			}
			// FIXME: check for dirty fields and stash/save the changes
			document.location.href = target + "#simply-edit";
			editor.plugins.dialog.close();
		};
		editor.plugins.fileBrowse.path = editor.storage.dataEndpoint ? editor.storage.dataEndpoint : editor.storage.endpoint;
		editor.plugins.fileBrowse.dialog.open();
	});
	editor.addAction("simply-file-browse-directory", function(el) {
		editor.plugins.fileBrowse.dialog.loadFiles(el.dataset.value);
	});
	editor.addAction("simply-file-browse-upload", function(el) {
		var target = el.parentNode.querySelector("input");
		muze.event.fire(target, "click");
	});
	editor.addAction("simply-file-browse-delete", function(el) {
		var targetList = document.querySelectorAll("#simply-file-browse .simply-dialog-body .simply-selected");
		var subpath;
		if (editor.plugins.fileBrowse.currentPath.indexOf(editor.storage.dataEndpoint) === 0) {
			if (confirm("Delete all selected pages? This action cannot be reversed and is final after you save.")) {
				for (var i=0; i<targetList.length; i++) {
					subpath = targetList[i].getAttribute("data-value").replace(editor.storage.dataEndpoint, "");
					(function(targetButton) {
						var data = JSON.parse(localStorage.data);
						delete data[subpath];
						localStorage.data = JSON.stringify(data);
						targetButton.parentNode.removeChild(targetButton);
					}(targetList[i]));
				}
			}
		} else {
			if (confirm("Delete all selected folders and files?")) {
				for (var i=0; i<targetList.length; i++) {
					if (targetList[i].querySelector("img")) {
						subpath = targetList[i].querySelector("img").getAttribute("src").replace(editor.storage.endpoint, "");
					} else {
						subpath = targetList[i].getAttribute("data-value").replace(editor.storage.endpoint, "");
					}
					(function(targetButton) {
						editor.storage.file.delete(subpath, function() {
							targetButton.parentNode.removeChild(targetButton);
						});
					}(targetList[i]));
				};
			}
		}
	});

	editor.addAction("simply-file-handle-upload", function(el) {
		editor.plugins.fileBrowse.handleFiles(el.files);
	});
	editor.addAction("simply-file-handle-add-folder", function(el) {
		var filename = el.parentNode.querySelector("input").value;
		if (editor.plugins.fileBrowse.currentPath.indexOf(editor.storage.dataEndpoint) === 0) {
			var subpath = editor.plugins.fileBrowse.currentPath.replace(editor.storage.dataEndpoint, "");
			var url = editor.plugins.fileBrowse.currentPath + "/" + filename.replace(/[^A-Za-z0-9_\.-]/, "-");

			(function(targetButton, url) {
				targetButton.innerHTML = "<div class='simply-button' data-simply-action='simply-file-browse-directory' data-value='" + url + "'><i class='select fa fa-check'></i><i class='fa fa-folder'></i>" + filename + "/</div>";
				newButton = targetButton.querySelector("div");
				targetButton.parentNode.insertBefore(newButton, targetButton);
				targetButton.parentNode.removeChild(targetButton);

				if (typeof editor.currentData[subpath + "/" + filename + "/"] === "undefined") {
					editor.currentData[subpath + "/" + filename + "/"] = {};
				}
			}(el.parentNode, url));

		} else {
			var url = editor.plugins.fileBrowse.currentPath + filename.replace(/[^A-Za-z0-9_\.-]/, "-") + '/';
			var subpath = editor.plugins.fileBrowse.currentPath.replace(editor.storage.endpoint, "");

			(function(targetButton, url) {
				editor.storage.file.save(subpath + filename + '/', '', function() {
					targetButton.innerHTML = "<div class='simply-button' data-simply-action='simply-file-browse-directory' data-value='" + url + "'><i class='select fa fa-check'></i><i class='fa fa-folder'></i>" + filename + "/</div>";
					newButton = targetButton.querySelector("div");
					targetButton.parentNode.insertBefore(newButton, targetButton);
					targetButton.parentNode.removeChild(targetButton);
				});
			}(el.parentNode, url));
		}
	});
	editor.addAction("simply-file-cancel-add-folder", function(el) {
		var target = el.parentNode;
		target.parentNode.removeChild(target);
	});
	editor.addAction("simply-file-browse-add-folder", function(el) {
		var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");
		var addButton = document.createElement("DIV");
		addButton.classList.add("simply-add-folder");
		addButton.innerHTML = '<i class="fa fa-folder"></i>';
		var addInput = document.createElement("input");
		addInput.type = "text";
		addInput.value = "new-folder";

		addSubmit = document.createElement("button");
		addSubmit.setAttribute("data-simply-action", "simply-file-handle-add-folder");
		addSubmit.classList.add('simply-add');
		addSubmit.innerHTML = '<i class="fa fa-check"></i>Add';

		addCancel = document.createElement("button");
		addCancel.setAttribute("data-simply-action", "simply-file-cancel-add-folder");
		addCancel.classList.add('simply-cancel');
		addCancel.innerHTML = '<i class="fa fa-times"></i>';
		addButton.appendChild(addInput);
		addButton.appendChild(addSubmit);
		addButton.appendChild(addCancel);
		targetList.appendChild(addButton);
		addInput.addEventListener("input", function(evt) {
			this.value = this.value.replace(/[^A-Za-z0-9_\.-]/g, '');
		});

		addInput.addEventListener("keydown", function(evt) {
			if (evt.keyCode == 13) { // enter
				muze.event.fire(addSubmit, "click");
				evt.stopPropagation();
			} else if (evt.keyCode == 27) { // ESC
				muze.event.fire(addCancel, "click");
				evt.stopPropagation();
			}
		});

		addInput.select();
		addInput.focus();
		window.setTimeout(function() { // give the mobile keyboard time to pop up;
			targetList.scrollTop = targetList.scrollHeight; // scroll the new element into view;
		}, 500);
	});

	editor.addAction("simply-file-handle-add-page", function(el) {
		var subpath = editor.plugins.fileBrowse.currentPath.replace(editor.storage.dataEndpoint, "");
		var filename = el.parentNode.querySelector("input").value;
		if (typeof editor.currentData[subpath + "/" + filename + "/"] === "undefined"){
			editor.storage.page.save(document.location.protocol + '//' + document.location.hostname + subpath + "/" + filename + "/");
		} else {
			alert("A page with that name already exists.");
			el.parentNode.querySelector("input").focus();
		}
	});
	editor.addAction("simply-file-cancel-add-page", function(el) {
		var target = el.parentNode;
		target.parentNode.removeChild(target);
	});
	editor.addAction("simply-file-browse-add-page", function(el) {
		var targetList = document.querySelector("#simply-file-browse .simply-dialog-body");
		var addButton = document.createElement("DIV");
		addButton.classList.add("simply-add-page");
		addButton.innerHTML = '<i class="fa fa-file-text-o"></i>';
		var addInput = document.createElement("input");
		addInput.type = "text";
		addInput.value = "new-page";

		addSubmit = document.createElement("button");
		addSubmit.setAttribute("data-simply-action", "simply-file-handle-add-page");
		addSubmit.classList.add('simply-add');
		addSubmit.innerHTML = '<i class="fa fa-check"></i>Add';

		addCancel = document.createElement("button");
		addCancel.setAttribute("data-simply-action", "simply-file-cancel-add-page");
		addCancel.classList.add('simply-cancel');
		addCancel.innerHTML = '<i class="fa fa-times"></i>';
		addButton.appendChild(addInput);
		addButton.appendChild(addSubmit);
		addButton.appendChild(addCancel);
		targetList.appendChild(addButton);
		addInput.addEventListener("input", function(evt) {
			this.value = this.value.replace(/[^A-Za-z0-9_\.-]/g, '');
		});

		addInput.addEventListener("keydown", function(evt) {
			if (evt.keyCode == 13) { // enter
				muze.event.fire(addSubmit, "click");
				evt.stopPropagation();
			} else if (evt.keyCode == 27) { // ESC
				muze.event.fire(addCancel, "click");
				evt.stopPropagation();
			}
		});

		addInput.select();
		addInput.focus();
		window.setTimeout(function() { // give the mobile keyboard time to pop up;
			targetList.scrollTop = targetList.scrollHeight; // scroll the new element into view;
		}, 500);
	});

	editor.plugins.fileBrowse.init();
</script>