<section id="simply-list-item" class="simply-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-list-item-delete"><i class="fa fa-times"></i>Delete</button></li>
			<li><button data-simply-action="simply-list-item-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
		<div class="simply-toolbar-section simply-list-templates">
			<ul>
				<li><button data-simply-action="simply-list-item-add"><i class="fa fa-cube"></i>Template</button></li>
			</ul>
		</div>
	</div>
</section>
<section id="simply-list" class="simply-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-list-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
		<div class="simply-toolbar-section simply-list-templates">
			<ul>
				<li><button data-simply-action="simply-list-item-add"><i class="fa fa-cube"></i>Template</button></li>
			</ul>
		</div>
	</div>
</section>
<script>
	var currentList, currentListItem;

	editor.plugins.list = {
		item : {
			add : function(el) {
				var targetNode = currentListItem;
				
				var targetObjectList = targetNode.parentNode;
				if (targetObjectList.getAttribute("data-simply-list")) {
					var template = el.getAttribute("data-simply-value");
					if (template === null) {
						template = Object.keys(targetObjectList.templates)[0];
					}

					editor.plugins.list.insertTemplate(targetObjectList, template, targetNode);
				}
			},
			delete : function() {
				var targetNode = currentListItem;
				var objectList = targetNode.parentNode;
				objectList.removeChild(targetNode);
				
				if (!objectList.querySelector("[data-simply-list-item]")) {
					objectList.classList.add("simply-empty");
				}

				editor.context.show(); // force toolbar context update to remove the toolbar pointing to the deleted item;

				// FIXME: register change stond hier;
			}
		},
		add : function(el) {
			var targetObjectList = currentList;

			if (targetObjectList.getAttribute("data-simply-list")) {
				var template = el.getAttribute("data-simply-value");
				if (template === null) {
					template = Object.keys(targetObjectList.templates)[0];
				}
				editor.plugins.list.insertTemplate(targetObjectList, template);
			}
		},
		insertTemplate : function(list, templateName, targetNode) {
			var template = list.templates[templateName];

			if (template) {
				var newNode = document.importNode(template.content, true);

				// Grr... android browser imports the nodes, except the contents of subtemplates. Find them and put them back where they belong.
				var originalTemplates = list.templates[templateName].content.querySelectorAll("template");
				var importedTemplates = newNode.querySelectorAll("template");

				for (var i=0; i<importedTemplates.length; i++) {
					importedTemplates[i].innerHTML = originalTemplates[i].innerHTML;
				}

				editor.data.list.init({}, newNode);

				editor.data.list.fixFirstElementChild(newNode);
				editor.data.list.fixFirstElementChild(list);

				counter = 0;
				for (t in list.templates) {
					counter++;
				}
				if (counter > 1) {
					newNode.firstElementChild.dataset.simplyTemplate = templateName;
				}

				newNode.firstElementChild.dataset.simplyListItem = true;
				newNode.firstElementChild.dataset.simplySelectable = true;

				if (list.templateIcons[templateName]) {
					newNode.firstElementChild.dataset.simplyListIcon = list.templateIcons[templateName];
				}

				var newListItem = newNode.firstElementChild;
				// save a reference so we can make it editable after it has gone into the document;

				var listItems = list.querySelectorAll(":scope > [data-simply-list-item]");

				if ( targetNode ) {
					list.insertBefore(newNode.firstElementChild, targetNode.nextElementSibling);
				} else if (listItems.length) {
					list.insertBefore(newNode.firstElementChild, listItems[listItems.length-1].nextSibling);
				} else {
					list.insertBefore(newNode.firstElementChild, list.firstElementChild);
				}

				muze.event.fire(document, "simply-selectable-inserted");
				editor.editmode.makeEditable(newListItem);

				list.classList.remove("simply-empty");
			}
		}
	};

	editor.addToolbar({
		name: 'simply-list-item',
		filter:{
			"selector" : "[data-simply-list-item]"
			/*"parent" : {
				"selector" : "[data-simply-list]"
			}*/
		},
		actions: {
			"simply-list-item-add" : editor.plugins.list.item.add,
			"simply-list-item-delete" : editor.plugins.list.item.delete
		},
		update : function(toolbar) {
			currentListItem = vdSelection.getNode(vdSelectionState.get());

			currentList = currentListItem.parentNode;
			while (currentList && !currentList.getAttribute('data-simply-list')) {
				currentList = currentList.parentNode;
			}

			var listTemplates = toolbar.querySelector("div.simply-list-templates ul");
			listTemplates.innerHTML = '';
			for (var i=0; i<Object.keys(currentList.templates).length; i++) {
				var templateName = Object.keys(currentList.templates)[i];
				var templateDisplay = templateName;				

				if (templateName == i) {
					templateDisplay = "Template " + (i+1);
				}
				
				var item = document.createElement("li");
				var itemIcon = '<i class="fa fa-cube"></i>';
				if (typeof currentList.templateIcons[templateName] !== "undefined") {
					if (currentList.templateIcons[templateName].indexOf("fa-") === 0) {
						itemIcon = '<i class="fa ' + currentList.templateIcons[templateName] + '"></i>';
					} else {
						itemIcon = '<i class="fa">' + currentList.templateIcons[templateName] + '</i>';
					}
				}

				item.innerHTML = '<button data-simply-action="simply-list-item-add" data-simply-value="' + templateName + '">' +
					itemIcon +
					templateDisplay + '</button>';

				listTemplates.appendChild(item);
			}
		
			var addButton = toolbar.querySelector("button[data-simply-action='simply-list-item-add'], button[data-simply-section='simply-list-templates']");

			if (Object.keys(currentList.templates).length > 1) {
				delete addButton.dataset.simplyAction;
				addButton.dataset.simplySection = "simply-list-templates";
				addButton.classList.add("simply-expands");
			} else { 
				delete addButton.dataset.simplySection;
				addButton.dataset.simplyAction = "simply-list-item-add";
				addButton.classList.remove("simply-expands");
			}
			addButton.classList.remove("simply-selected");
			toolbar.querySelector("div.simply-list-templates").classList.remove("simply-selected");

		}
	});
	
	editor.addToolbar({
		name: 'simply-list',
		filter:{
			"selector" : "[data-simply-list]"
			/*"parent" : {
				"selector" : "[data-simply-list]"
			}*/
		},
		init: function() {
		},
		actions: {
			"simply-list-add" : editor.plugins.list.add
		},
		update : function(toolbar) {
			currentList = vdSelection.getNode(vdSelectionState.get());

			var listTemplates = toolbar.querySelector("div.simply-list-templates ul");
			listTemplates.innerHTML = '';
			for (var i=0; i<Object.keys(currentList.templates).length; i++) {
				var templateName = Object.keys(currentList.templates)[i];
				var templateDisplay = templateName;				

				if (templateName == i) {
					templateDisplay = "Template " + (i+1);
				}
				
				var item = document.createElement("li");
				var itemIcon = '<i class="fa fa-cube"></i>';
				if (typeof currentList.templateIcons[templateName] !== "undefined") {
					if (currentList.templateIcons[templateName].indexOf("fa-") === 0) {
						itemIcon = '<i class="fa ' + currentList.templateIcons[templateName] + '"></i>';
					} else {
						itemIcon = '<i class="fa">' + currentList.templateIcons[templateName] + '</i>';
					}
				}

				item.innerHTML = '<button data-simply-action="simply-list-add" data-simply-value="' + templateName + '">' +
					itemIcon +
					templateDisplay + '</button>';

				listTemplates.appendChild(item);
			}
		
			var addButton = toolbar.querySelector("button[data-simply-action='simply-list-add'], button[data-simply-section='simply-list-templates']");

			if (Object.keys(currentList.templates).length > 1) {
				delete addButton.dataset.simplyAction;
				addButton.dataset.simplySection = "simply-list-templates";
				addButton.classList.add("simply-expands");
			} else { 
				delete addButton.dataset.simplySection;
				addButton.dataset.simplyAction = "simply-list-add";
				addButton.classList.remove("simply-expands");
			}
			addButton.classList.remove("simply-selected");
			toolbar.querySelector("div.simply-list-templates").classList.remove("simply-selected");
		}
	});
	editor.addContextFilter(
		"simply-list-and-item", {
			"selector" : "[data-simply-list][data-simply-list-item]",
			"context" : "simply-list"
		}
	);
</script>