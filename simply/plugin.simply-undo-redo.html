<script type="text/javascript">
	editor.plugins.undoRedo = {
		currentUndo : -1,
		undoSet : [],
		timer : false,
		isEqual : function(data1, data2) {
			if (typeof data1 === "undefined" || typeof data2 === "undefined") {
				return false;
			}
			if (JSON.stringify(data1) == JSON.stringify(data2)) {
				return true;
			}
			return false;
		},
		storeUndo : function(undoAction) {
			if (editor.plugins.undoRedo.undoing) {
				return;
			}
			editor.plugins.undoRedo.undoSet.splice(editor.plugins.undoRedo.currentUndo + 1);
			editor.plugins.undoRedo.undoSet.push(undoAction);
			editor.plugins.undoRedo.currentUndo++;

			editor.toolbars["simply-undo-redo"].update();
		},
		undo : function() {
			if (!editor.plugins.undoRedo.canUndo()) {
				return;
			}
			editor.plugins.undoRedo.undoing = true;
			editor.context.toolbar.hide = true;
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo];
			if (typeof undoStep !== "undefined") {
				var currentScroll = document.body.scrollTop; // removing the items will reset the scrolloffset;
				undoStep.undo();
				document.body.scrollTop = currentScroll;
				editor.plugins.undoRedo.currentUndo--;
			}
			editor.plugins.undoRedo.undoing = false;
			editor.toolbars["simply-undo-redo"].update();
		},
		redo : function() {
			if (!editor.plugins.undoRedo.canRedo()) {
				return;
			}
			editor.plugins.undoRedo.undoing = true;
			editor.context.toolbar.hide = true;
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo + 1];
			if (typeof undoStep !== "undefined") {
				var currentScroll = document.body.scrollTop; // removing the items will reset the scrolloffset;
				undoStep.redo();
				document.body.scrollTop = currentScroll;
				editor.plugins.undoRedo.currentUndo++;
			}
			editor.plugins.undoRedo.undoing = false;
			editor.toolbars["simply-undo-redo"].update();
		},
		canUndo : function() {
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo];
                        if (typeof undoStep !== "undefined") {
				return true;
			}
			return false;
		},
		canRedo : function() {
			var undoStep = editor.plugins.undoRedo.undoSet[editor.plugins.undoRedo.currentUndo + 1];
			if (typeof undoStep !== "undefined") {
				return true;
			}
			return false;
		},
		changeHandler : function(evt) {
			if (!editor.plugins.undoRedo.undoing) {
				var dataBinding = evt.data.dataBinding;
				var newValue = evt.data.arguments[1];
				var oldValue = evt.data.arguments[2];

				var dataPath = editor.data.getDataPath(dataBinding.elements[0]);

				var set = function(value) {
					var targetValue = editor.currentData[dataPath];
					var subkeys = dataBinding.parentKey.split("/");
					var subkey;
					while (subkeys.length) {
						subkey = subkeys.shift();
						if (subkey != "") {
							targetValue = targetValue[subkey];
						}
					}
					targetValue[dataBinding.key] = value;
					dataBinding.resolve(true);
				};
					
				var undoAction = {
					undo : function() {
						set(oldValue);
					},
					redo : function() {
						set(newValue);
					}
				};
				editor.plugins.undoRedo.storeUndo(undoAction);
			}
		}
	};

	editor.addToolbar({
		name : 'simply-undo-redo',
		init : function() {
			var listItem = document.createElement("li");
			var button = document.createElement("button");
			button.dataset.simplyAction = "simply-undo";
			button.setAttribute("disabled", true);
			button.innerHTML = '<i class="fa fa-undo"></i>Undo';
			listItem.appendChild(button);
			document.querySelector("#simply-main-toolbar .simply-buttons").appendChild(listItem);

			listItem = document.createElement("li");
			button = document.createElement("button");
			button.dataset.simplyAction = "simply-redo";
			button.setAttribute("disabled", true);
			button.innerHTML = '<i class="fa fa-repeat"></i>Redo';
			listItem.appendChild(button);
			document.querySelector("#simply-main-toolbar .simply-buttons").appendChild(listItem);
			document.addEventListener("simply-data-changed", editor.plugins.undoRedo.changeHandler);
		},
		update : function() {
			var undoButton = document.querySelector("#simply-main-toolbar [data-simply-action=simply-undo]");
			var redoButton = document.querySelector("#simply-main-toolbar [data-simply-action=simply-redo]");

			if (editor.plugins.undoRedo.canUndo()) {
				if (undoButton && undoButton.getAttribute("disabled")) {
					undoButton.removeAttribute("disabled");
				}
			} else {
				if (undoButton && !undoButton.getAttribute("disabled")) {
					undoButton.setAttribute("disabled", true);
				}
			}
			if (editor.plugins.undoRedo.canRedo()) {
				if (redoButton && redoButton.getAttribute("disabled")) {
					redoButton.removeAttribute("disabled");
				}
			} else {
				if (redoButton && !redoButton.getAttribute("disabled")) {
					redoButton.setAttribute("disabled", true);
				}
			}
		},
		actions : {
			"simply-undo" : function() {
				editor.plugins.undoRedo.undo();
				editor.toolbars["simply-undo-redo"].update();
			},
			"simply-redo" : function() {
				editor.plugins.undoRedo.redo();
				editor.toolbars["simply-undo-redo"].update();
			}
		}
	});
</script>