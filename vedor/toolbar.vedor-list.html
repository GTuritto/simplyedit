<section id="vedor-list-item" class="vedor-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-list-item-delete"><i class="fa fa-times"></i>Delete</button></li>
			<li><button data-vedor-action="vedor-list-item-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-list-templates">
			<ul>
				<li><button data-vedor-action="vedor-list-item-add"><i class="fa fa-cube"></i>Template</button></li>
			</ul>
		</div>
	</div>
</section>
<section id="vedor-list" class="vedor-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-list-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-list-templates">
			<ul>
				<li><button data-vedor-action="vedor-list-item-add"><i class="fa fa-cube"></i>Template</button></li>
			</ul>
		</div>
	</div>
</section>
<script>
	var currentList, currentListItem;

	editor.plugins.list = {
		item : {
			add : function(el) {
				var targetNode = currentListItem;
				
				var targetObjectList = targetNode.parentNode;
				if (targetObjectList.getAttribute("data-vedor-list")) {
					var template = el.getAttribute("data-vedor-value");
					if (template === null) {
						template = Object.keys(targetObjectList.templates)[0];
					}
					editor.plugins.list.insertTemplate(targetObjectList, template);
				}
			},
			delete : function() {
				var targetNode = currentListItem;
				var objectList = targetNode.parentNode;
				objectList.removeChild(targetNode);
				
				if (!objectList.querySelector("[data-vedor-list-item]")) {
					objectList.classList.add("vedor-empty");
				}

				editor.context.show(); // force toolbar context update to remove the toolbar pointing to the deleted item;

				// FIXME: register change stond hier;
			}
		},
		add : function(el) {
			var targetObjectList = currentList;

			if (targetObjectList.getAttribute("data-vedor-list")) {
				var template = el.getAttribute("data-vedor-value");
				if (template === null) {
					template = Object.keys(targetObjectList.templates)[0];
				}
				editor.plugins.list.insertTemplate(targetObjectList, template);
			}
		},
		insertTemplate : function(list, templateName) {
			var template = list.templates[templateName];
			if (template) {
				var newNode = document.importNode(template.content, true);
				editor.data.list.init({}, newNode);

				editor.editmode.editable(newNode);
				newNode.firstElementChild.dataset.vedorTemplate = templateName;
				newNode.firstElementChild.dataset.vedorListItem = true;
				newNode.firstElementChild.dataset.vedorSelectable = true;

				var listItems = list.querySelectorAll(":scope > [data-vedor-list-item]");
				if (listItems.length) {
					list.insertBefore(newNode.children[0], listItems[listItems.length-1].nextSibling);
				} else {
					list.insertBefore(newNode.children[0], list.firstElementChild);
				}
				list.classList.remove("vedor-empty");
				list.appendChild(newNode);
			}
		}
	};

	editor.addToolbar({
		name: 'vedor-list-item',
		filter:{
			"selector" : "[data-vedor-list-item]"
			/*"parent" : {
				"selector" : "[data-vedor-list]"
			}*/
		},
		actions: {
			"vedor-list-item-add" : editor.plugins.list.item.add,
			"vedor-list-item-delete" : editor.plugins.list.item.delete
		},
		update : function(toolbar) {
			currentListItem = vdSelection.getNode(vdSelectionState.get());

			currentList = currentListItem.parentNode;
			var listTemplates = toolbar.querySelector("div.vedor-list-templates ul");
			listTemplates.innerHTML = '';
			for (var i=0; i<Object.keys(currentList.templates).length; i++) {
				var templateName = Object.keys(currentList.templates)[i];
				var templateDisplay = templateName;				

				if (templateName == i) {
					templateDisplay = "Template " + (i+1);
				}
				
				var item = document.createElement("li");
				item.innerHTML = '<button data-vedor-action="vedor-list-item-add" data-vedor-value="' + templateName + '"><i class="fa fa-cube"></i>' + templateDisplay + '</button>';
				listTemplates.appendChild(item);
			}
		
			var addButton = toolbar.querySelector("button[data-vedor-action='vedor-list-item-add'], button[data-vedor-section='vedor-list-templates']");

			if (Object.keys(currentList.templates).length > 1) {
				delete addButton.dataset.vedorAction;
				addButton.dataset.vedorSection = "vedor-list-templates";
				addButton.classList.add("vedor-expands");
			} else { 
				delete addButton.dataset.vedorSection;
				addButton.dataset.vedorAction = "vedor-list-item-add";
				addButton.classList.remove("vedor-expands");
			}
			addButton.classList.remove("vedor-selected");
			toolbar.querySelector("div.vedor-list-templates").classList.remove("vedor-selected");

		}
	});
	
	editor.addToolbar({
		name: 'vedor-list',
		filter:{
			"selector" : "[data-vedor-list]"
			/*"parent" : {
				"selector" : "[data-vedor-list]"
			}*/
		},
		init: function() {
		},
		actions: {
			"vedor-list-add" : editor.plugins.list.add
		},
		update : function(toolbar) {
			currentList = vdSelection.getNode(vdSelectionState.get());

			var listTemplates = toolbar.querySelector("div.vedor-list-templates ul");
			listTemplates.innerHTML = '';
			for (var i=0; i<Object.keys(currentList.templates).length; i++) {
				var templateName = Object.keys(currentList.templates)[i];
				var templateDisplay = templateName;				

				if (templateName == i) {
					templateDisplay = "Template " + (i+1);
				}
				
				var item = document.createElement("li");
				item.innerHTML = '<button data-vedor-action="vedor-list-add" data-vedor-value="' + templateName + '"><i class="fa fa-cube"></i>' + templateDisplay + '</button>';
				listTemplates.appendChild(item);
			}
		
			var addButton = toolbar.querySelector("button[data-vedor-action='vedor-list-add'], button[data-vedor-section='vedor-list-templates']");

			if (Object.keys(currentList.templates).length > 1) {
				delete addButton.dataset.vedorAction;
				addButton.dataset.vedorSection = "vedor-list-templates";
				addButton.classList.add("vedor-expands");
			} else { 
				delete addButton.dataset.vedorSection;
				addButton.dataset.vedorAction = "vedor-list-add";
				addButton.classList.remove("vedor-expands");
			}
			addButton.classList.remove("vedor-selected");
			toolbar.querySelector("div.vedor-list-templates").classList.remove("vedor-selected");
		}
	});	
</script>