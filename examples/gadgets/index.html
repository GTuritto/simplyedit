<!DOCTYPE HTML>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title data-simply-field="meta title">Simply edit - RSS datasource example</title>
	<meta name="description" content="Simple edit testpage description" data-simply-field="meta description">
	<meta name="robots" content="noindex,nofollow" data-simply-field="meta robots">
	<meta name="author" content="" data-simply-field="meta author">
	<meta name="page-template" content="index.html" data-simply-field="data-simply-page-template">
	<meta charset="utf-8"> 
	<link rel="stylesheet" href="rss.css" type="text/css">
	<link rel="stylesheet" href="flickr.css" type="text/css">
</head>
<body>
	<div data-simply-list="gadgets" data-simply-sortable=true>
		<template data-simply-template="RSS">
			<div class="simply-gadget">
				<div class="news" data-simply-list="tech" data-simply-data="rss" data-simply-feed="http://crossorigin.me/http://www.nu.nl/rss/Tech">
					<template data-simply-template="large"><div class="large article">
						<a href="#" data-simply-field="url">
							<img src="" data-simply-field="image">
							<h1 data-simply-field="title">title</h1>
							<div data-simply-field="description">description</div>
						</a>
					</div></template>
					<template data-simply-template="small"><div class="small article">
						<a href="#" data-simply-field="url">
							<h2 data-simply-field="title">title</h1>
							<img src="" data-simply-field="image">
						</a>
						</div></template>
				</div>
			</div>
		</template>
		<template data-simply-template="Flickr">
			<div class="simply-gadget">
				<div class="photoGrid" data-simply-list="gallery" data-simply-data="gallery" data-simply-feed="https://crossorigin.me/https://api.flickr.com/services/feeds/photos_public.gne?tags=nature&lang=en-us&format=json">
					<template>
						<a class="item" href="#" data-simply-field="url"><img data-simply-field="image"></a>
					</template>
				</div>
			</div>
		</template>
	</div>

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="http://www.jqueryscript.net/demo/jQuery-Responsive-Justified-Image-Gallery-Plugin-Photogrid-js/jquery.photogrid.js"></script>
	<script src="/simply-edit/js/simply-edit.js" 
		x-data-api-key="muze" 
		data-simply-endpoint="http://yvo.muze.nl/ariadne/loader.php/system/users/yvo/simply-store/"
		data-simply-images="http://yvo.muze.nl/ariadne/loader.php/system/users/yvo/simply-store/img/"
	></script>
	<script>
		editor.loadToolbar("toolbar.simply-rss.html");
		editor.loadToolbar("toolbar.simply-gallery.html");
	</script>
	<script>
		editor.addDataSource("rss", {
			load : function(list, callback) {
				var url = list.getAttribute("data-simply-feed");
				var max = 2;
				var http = new XMLHttpRequest();

				http.open("GET", url, true);
				http.onreadystatechange = function() {//Call a function when the state changes.
					if(http.readyState == 4) {
						if (http.status == 200) {
							var parser = new DOMParser();
							var xmlDoc = parser.parseFromString(http.responseText, "text/xml");

							var items = xmlDoc.querySelectorAll("item");
							var result = [];
							var unescape = function(text) {
			 					text = text.replace(/&amp;/g, "&");
			 					text = text.replace(/&gt;/g, ">");
			 					text = text.replace(/&lt;/g, "<");
								return text;
							};	

							for (var i=0; i<items.length && (max ? (i < max) : true); i++) {
								result.push({
									title : unescape(items[i].querySelector("title").innerHTML),
									description : unescape(items[i].querySelector("description").innerHTML),
									image : items[i].querySelector("enclosure").getAttribute("url"),
									url : {
										href : items[i].querySelector("link").innerHTML.replace("&amp;", "&")
									},
									"data-simply-template" : ((i < 2) ? "large" : "small" )
								});
							}
							callback(result);
						}
					}
				};
				http.send();
			},
			get : function(list) {
				return {
					"data-simply-feed" : list.getAttribute("data-simply-feed")
				}
			},
			set : function(list, data) {
				list.setAttribute("data-simply-feed", data["data-simply-feed"]);
			}
		});
		editor.addDataSource("gallery", {
			load : function(list, callback) {
				var url = list.getAttribute("data-simply-feed");
				var max = 8;

				var http = new XMLHttpRequest();
				var jsonFlickrFeed = function(data) {
					var items = data.items;
					for (var i=0; i<items.length && (max ? (i < max) : true); i++) {
						items[i].url = {
							href : items[i].link
						};
						items[i].image = items[i].media.m;
					}
					callback(items);
					window.setTimeout(function() {
						$(list).photoGrid({
							rowHeight: "200"
			   			});
					}, 800);
				};
						
				http.open("GET", url, true);
				http.onreadystatechange = function() {//Call a function when the state changes.
					if(http.readyState == 4) {
						if (http.status == 200) {
							eval(http.responseText);
						}
					}
				};
				http.send();
			},
			get : function(list) {
				return {
					"data-simply-feed" : list.getAttribute("data-simply-feed")
				}
			},
			set : function(list, data) {
				list.setAttribute("data-simply-feed", data["data-simply-feed"]);
			}
		});
	</script>
</body>
</html>