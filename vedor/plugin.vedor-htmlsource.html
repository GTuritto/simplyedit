<section id="vedor-htmlsource" class="vedor-dialog">
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-htmlsource-selectall"><i class="fa fa-quote-right"></i>Select field</button></li>
			<li><button data-vedor-action="vedor-htmlsource-editable"><i class="fa fa-lock"></i>Source is static</button></li>
			<li><button data-vedor-action="vedor-htmlsource-fullscreen"><i class="fa fa-expand"></i>Full screen</button></li>
		</ul>
	</div>
	<div class="vedor-dialog-body">
		<div class="vdYellowAlert" id="vdInsertHTMLWarning" style="display: none;">
			Warning: editable source and javascript do not mix.
		</div>
		<textarea id="vdInsertHTMLSource"></textarea>
	</div>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-htmlsource-close"><i class="fa fa-times"></i>Cancel</button></li>
			<li class='vedor-right'><button data-vedor-action="vedor-htmlsource-insert"><i class="fa fa-check"></i>Insert</button></li>
		</ul>
	</div>
</section>
<style type="text/css">
	#vedor-htmlsource {
		top: 50%;
		height: 400px;
		max-height: 80%;
		margin-top: -200px;

		left: 50%;
		width: 500px;
		max-width: 80%;
		margin-left: -250px;
	}
	#vedor-htmlsource .vedor-dialog-body {
		background-color: #eee;
	}
	#vedor-htmlsource.fullscreen {
		top: 0px;
		bottom: 0px;
		left: 0px;
		right: 0px;
		max-width: 100%;
		max-height: 100%;
		height: auto;
		width: auto;
		margin-left: 0px;
		margin-top: 0px;
	}

	#vedor-htmlsource textarea {
		width: 100%;
		height: 100%;
		border: 1px solid #9F9F9F;
		background-color: white;
		box-sizing: border-box;
	}
	#vdInsertHTMLWarning {
		background-color: #FFFFCC;
		border: 1px solid black;
		padding: 2px;
		clear: both;
		height: 32px;
		overflow: hidden;
	}
</style>
<script>
	editor.plugins.htmlsource = {
		currentField : null,
		currentSel : null,
		selectAll : function() {
			var element = editor.plugins.htmlsource.currentField;
			var sel = vdSelectionState.get();
			vdSelection.selectNode(sel, element);
			vdSelectionState.save(sel);
			vdSelectionState.selectAll = true;
			editor.plugins.htmlsource.dialog.setSource();
		},
		getSourceSpan() {
			var parent=false;
			var sel = vdSelectionState.get();
			if (sel) {
				parent = vdSelection.getNode(sel);
				while (parent && (parent.tagName=='DIV' || parent.tagName=='SPAN') && parent.parentNode && !parent.getAttribute('data-vedor-htmlsource')) {
					parent=parent.parentNode;
				}
				if (!parent || (parent.tagName!='DIV' && parent.tagName!='SPAN') || !parent.getAttribute('data-vedor-htmlsource')) {
					parent=false;
				}
			}
			return parent;
		},
		get : function() {
			var span = editor.plugins.htmlsource.getSourceSpan();
			if (span) {
				return vedor.util.base64.decode(span.getAttribute('data-vedor-htmlsource'));
			} else {
				var sel = vdSelectionState.get();
				return vdSelection.getHTMLText(sel);
			}
		},
		dialog : {
			setSource : function() {
				var source = editor.plugins.htmlsource.get();
				document.getElementById('vdInsertHTMLSource').value = source;

				var span = editor.plugins.htmlsource.getSourceSpan();
				var button = document.querySelector("[data-vedor-action=vedor-htmlsource-editable]");
				if (span) {
					button.classList.add("vedor-selected");
				} else {
					button.classList.remove("vedor-selected");
				}
				document.getElementById('vdInsertHTMLSource').select();

				var fullscreen = document.querySelector("[data-vedor-action=vedor-htmlsource-fullscreen]");
				if (document.getElementById('vedor-htmlsource').classList.contains("fullscreen")) {
					fullscreen.classList.add("vedor-selected");
				} else {
					fullscreen.classList.remove("vedor-selected");
				}
			},
			open : function() {
				editor.plugins.htmlsource.currentSel = vdSelectionState.get();
				editor.plugins.htmlsource.currentField = editor.node.getEditableField();
				vdSelectionState.save(editor.plugins.htmlsource.currentSel);

				editor.plugins.dialog.open(document.getElementById('vedor-htmlsource'), editor.plugins.htmlsource.dialog.setSource);
				editor.plugins.htmlsource.dialog.resize();
			},
			close : function() {
				editor.plugins.dialog.close(
					document.getElementById('vedor-htmlsource'),
					function() {
						vdSelectionState.restore();
						vdSelectionState.remove();
						vdSelectionState.selectAll = false;
						vdSelectionState.selectedElement = false;
						vdEditPane_DisplayChanged();
					}
				);
			},
			resize : function() {
				var button = document.querySelector("[data-vedor-action=vedor-htmlsource-editable]");
				if (button && button.classList.contains("vedor-selected")) {
					document.getElementById('vdInsertHTMLWarning').style.display='block';
				} else {
					document.getElementById('vdInsertHTMLWarning').style.display='none';
				}
			},
			fullscreen : function() {
				var fullscreen = document.querySelector("[data-vedor-action=vedor-htmlsource-fullscreen]");
				if (document.getElementById('vedor-htmlsource').classList.contains("fullscreen")) {
					fullscreen.classList.remove("vedor-selected");
					document.getElementById('vedor-htmlsource').classList.remove("fullscreen");
				} else {
					fullscreen.classList.add("vedor-selected");
					document.getElementById('vedor-htmlsource').classList.add("fullscreen");
				}
			}
		},
		tidy : function(html) {
			var d = document.createElement('div');
			d.innerHTML = html;
			return d.innerHTML;
		},
		insert : function() {
			var source = document.getElementById('vdInsertHTMLSource').value;
			var tidySource = editor.plugins.htmlsource.tidy(source);
			if (tidySource != source) {
				if (confirm("The HTML content does not seem valid and cannot be inserted. Correct it automatically?")) {
					document.getElementById('vdInsertHTMLSource').value = tidySource;
				}
				return;
			}

			var field=editor.plugins.htmlsource.currentField;
			if (field) {
				var button = document.querySelector("[data-vedor-action=vedor-htmlsource-editable]");
				if (button && button.classList.contains("vedor-selected")) {
					var encodedsource = vedor.util.base64.encode(source); // this makes sure IE doesn't touch the sourcecode.
					source = '<div data-vedor-htmlsource="'+encodedsource+'" contenteditable="false">'+source+'</div>';
				}
				if (vdSelectionState.selectAll) {
					field.innerHTML = source;
				} else {
					editor.plugins.text.formatInline('delete'); // this is somehow needed to trick IE into breaking potential <P>'s into 2
					vdSelection.setHTMLText(editor.plugins.htmlsource.currentSel, source);
				}
			}
			vdSelectionState.selectAll = false;
			editor.plugins.htmlsource.currentField = false;
			editor.plugins.htmlsource.dialog.close();
		}
	};

	editor.addAction("vedor-insert-source", editor.plugins.htmlsource.dialog.open);
	editor.addAction("vedor-edit-source", editor.plugins.htmlsource.dialog.open);
	editor.addAction("vedor-htmlsource-close", editor.plugins.htmlsource.dialog.close);
	editor.addAction("vedor-htmlsource-selectall", editor.plugins.htmlsource.selectAll);
	editor.addAction("vedor-htmlsource-insert", editor.plugins.htmlsource.insert);
	editor.addAction("vedor-htmlsource-fullscreen", editor.plugins.htmlsource.dialog.fullscreen);
</script>
