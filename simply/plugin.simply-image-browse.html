<section id="simply-image-browse" class="simply-dialog simply-modal">
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-image-browse-filter-same-size"><i class="fa fa-filter"></i>Same size only</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-close"><i class="fa fa-times"></i>Cancel</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-fullscreen"><i class="fa fa-expand"></i>Full screen</button></li>
		</ul>
	</div>
	<div class="simply-dialog-body">
	</div>
</section>
<style type="text/css">
	#simply-image-browse .simply-dialog-body button {
		border: 1px solid #eee;
		background-color: white;
		height: 149px;
		width: 149px;
		font-family: inherit;
		font-size: 20px;
		position: relative;
		padding: 5px;
		color: #999 !important;
		display: inline-block;
		vertical-align: top;
	}
	#simply-image-browse .simply-dialog-body button:before {
		display: block;
		content: '';
		position: absolute;
		top: 0px;
		left: 0px;
		height: 100%;
		width: 100%;
	}
        #simply-image-browse .simply-dialog-body button i {
		font-size: 48px;
		display: block;
		width: 100%;
		text-align: center;
	}
	#simply-image-browse .simply-dialog-body button img {
		max-width: 100%;
		max-height: 100%;
	}

	@media (max-width: 481px) {
		#simply-image-browse .simply-dialog-body button {
			width: 50%;
		}
	}
</style>
<script>
	editor.plugins.imageBrowse = {
		currentSel : null,
		currentField : null,
		currentJail : null,
		path : document.querySelector("[data-simply-images]") ? document.querySelector("[data-simply-images]").getAttribute("data-simply-images") : null,
		dialog : {
			open : function() {
				editor.plugins.imageBrowse.currentSel = vdSelectionState.get();
				editor.plugins.imageBrowse.currentField = editor.node.getEditableField();
				editor.plugins.imageBrowse.currentJail = null;

				vdSelectionState.save(editor.plugins.imageBrowse.currentSel);
				editor.plugins.dialog.open(document.getElementById('simply-image-browse'), editor.plugins.imageBrowse.dialog.update);
			},
			loadImages : function(url) {
				var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
				if (editor.plugins.imageBrowse.currentJail === null) {
					var parser = document.createElement("A");
					parser.href = url;
					editor.plugins.imageBrowse.currentJail = parser.href;
				}

				editor.storage.list(url, function(imageData) {
					var i;
					var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
					var newHtml = '';
					for (i=0; i<imageData.folders.length; i++) {
						if (imageData.folders[i].url.indexOf(editor.plugins.imageBrowse.currentJail) === 0) {
							newHtml += "<button data-simply-action='simply-image-browse-directory' data-value='" + imageData.folders[i].url + "'><i class='fa fa-folder'></i>" + imageData.folders[i].name + "</button>";
						}
					}
					for (i=0; i<imageData.images.length; i++) {
						if (imageData.images[i].url.indexOf(editor.plugins.imageBrowse.currentJail) === 0) {
							var src = imageData.images[i].url;
							if (typeof imageData.images[i].src !== "undefined") {
								src = imageData.images[i].src;
							}

							newHtml += "<button data-simply-action='simply-image-browse-insert'><img src='" + src + "'></button>";
						}
					}
					targetList.innerHTML = newHtml;
					targetList.scrollTop = 0;
					document.querySelector("#simply-image-browse [data-simply-action=simply-image-browse-filter-same-size]").classList.remove("simply-selected");
				});
			},
			update : function() {
				// var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
				editor.plugins.imageBrowse.dialog.loadImages(editor.plugins.imageBrowse.path);
			}
		},
		init : function() {
			if (editor.plugins.imageBrowse.path) {
				var target = document.querySelectorAll("#simply-image .simply-toolbar .simply-buttons, #simply-image-field .simply-toolbar .simply-buttons");
				if (target) {
					var i;
					for (i=0; i<target.length; i++) {
						var button = document.createElement("LI");
						button.innerHTML = '<button data-simply-action="simply-image-browse"><i class="fa fa-folder"></i>Browse</button>';
						target[i].appendChild(button);
					}

					target = document.querySelectorAll('[data-simply-action="simply-image-src"]');
					if (target) {
						for (i=0; i<target.length; i++) {
							var button = document.createElement("div");
							button.innerHTML = '<button data-simply-action="simply-image-browse"><i class="fa fa-folder"></i></button>';
							target[i].parentNode.querySelector("label").appendChild(button.firstChild);
						}
					}
				} else {
					window.setTimeout(editor.plugins.imageBrowse.init, 200);
				}
			}
		}
	};

	editor.addAction("simply-image-browse", editor.plugins.imageBrowse.dialog.open);
	editor.addAction("simply-image-browse-directory", function(el) {
		editor.plugins.imageBrowse.dialog.loadImages(el.dataset.value);
	});
	editor.addAction("simply-image-browse-insert", function(el) {
		editor.actions["simply-image-src"](el.querySelector("img").getAttribute("src"));

		//var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
		//parent.setAttribute("src", el.querySelector("img").getAttribute("src"));
		editor.plugins.dialog.close();
	});
	editor.addAction("simply-image-browse-filter-same-size", function(el) {
		var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
		var currentWidth = parent.naturalWidth;
		var currentHeight = parent.naturalHeight;
		var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
		var imageList = targetList.querySelectorAll("button img");
		if (el.classList.contains("simply-selected")) {
			for (var i=0; i<imageList.length; i++) {
				imageList[i].parentNode.style.display = "inline-block";
			}
			el.classList.remove("simply-selected");
		} else {
			for (var i=0; i<imageList.length; i++) {
				if (
					imageList[i].naturalWidth == parent.naturalWidth &&
					imageList[i].naturalHeight == parent.naturalHeight
				) {
					imageList[i].parentNode.style.display = "inline-block";
				} else {
					imageList[i].parentNode.style.display = "none";
				}
			}
			el.classList.add("simply-selected");
		}
	});

	editor.plugins.imageBrowse.init();
</script>