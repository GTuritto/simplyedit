<section id="simply-text-cursor" class="simply-section">
	<h1>*HTML Toolbar for Text Cursor*</h1>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-section="simply-text-style" class="simply-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-simply-section="simply-text-class" class="simply-expands"><i class="fa fa-paint-brush"></i>Class</button></li>
			<li><button data-simply-section="simply-text-align" class="simply-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-simply-section="simply-insert" class="simply-expands"><i class="fa fa-plus"></i>Insert</button></li>
			<li><button data-simply-action="simply-hyperlink-follow"><i class="fa fa-external-link"></i>Follow link</button></li>
		</ul>
		<div class="simply-toolbar-section simply-text-style">
			<ul>
				<li class="simply-text-format"><select data-simply-action="simply-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
					<option value="ol">Numbered list</option>
					<option value="ul">Unnumbered list</option>
					<option value="">(plain text)</option>
				</select></li>
			</ul>
			<ul class="simply-text-inline">
				<li><button data-simply-action="simply-text-inline" data-value="strong"><i class="fa fa-bold"></i>Bold</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="em"><i class="fa fa-italic"></i>Italic</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="u"><i class="fa fa-underline"></i>Underline</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="code"><i class="fa fa-code"></i>[Code]</button></li>
			</ul>
		</div>
		<div class="simply-toolbar-section simply-text-class">
		</div>
		<div class="simply-toolbar-section simply-text-align">
			<ul data-type="simply-buttongroup-radio">
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-left"><i class="fa fa-align-left"></i>Left</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-center"><i class="fa fa-align-center"></i>Center</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-right"><i class="fa fa-align-right"></i>Right</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
				<li><button data-simply-action="simply-text-class" data-value="none"><i class="fa fa-times"></i>None</button></li>
			</ul>
		</div>
		<div class="simply-toolbar-section simply-insert">
			<ul>
				<li><button data-simply-action="simply-insert-image" data-simply-section="simply-insert-image"><i class="fa fa-picture-o"></i>Image</button></li>
				<li><button data-simply-action="simply-insert-source" data-simply-section="simply-insert-source"><i class="fa fa-code"></i>Code</button></li>
			</ul>
		</div>
	</div>
</section>
<section id="simply-text-selection" class="simply-section">
	<h1>*HTML Toolbar for Text Selection*</h1>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-section="simply-text-style" class="simply-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-simply-section="simply-text-class" class="simply-expands"><i class="fa fa-paint-brush"></i>Class</button></li>
			<li><button data-simply-section="simply-text-align" class="simply-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-simply-section="simply-hyperlink" class="simply-expands"><i class="fa fa-link"></i>Link</button></li>
			<li><button data-simply-section="simply-insert" class="simply-expands"><i class="fa fa-plus"></i>Insert</button></li>
			<li><button data-simply-action="simply-hyperlink-follow"><i class="fa fa-external-link"></i>Follow link</button></li>
		</ul>
		<div class="simply-toolbar-section simply-text-style">
			<ul>
				<li class="simply-text-format"><select data-simply-action="simply-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
					<option value="ol">Numbered list</option>
					<option value="ul">Unnumbered list</option>
					<option value="">(plain text)</option>
				</select></li>
			</ul>
			<ul class="simply-text-inline">
				<li><button data-simply-action="simply-text-inline" data-value="strong"><i class="fa fa-bold"></i>Bold</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="em"><i class="fa fa-italic"></i>Italic</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="u"><i class="fa fa-underline"></i>Underline</button></li>
				<li><button data-simply-action="simply-text-inline" data-value="code"><i class="fa fa-code"></i>[Code]</button></li>
			</ul>
		</div>
		<div class="simply-toolbar-section simply-text-class">
		</div>
		<div class="simply-toolbar-section simply-hyperlink">
			<div><label>URL</label><input type="text" id="vdHyperlinkHref" data-simply-action="simply-hyperlink-href"></div>
			<div><label>Title</label><input type="text" id="vdHyperlinkTitle" data-simply-action="simply-hyperlink-title"></div>
			<div><label>Name</label><input type="text" id="vdHyperlinkName" data-simply-action="simply-hyperlink-name"></div>
			<div>
				<button class="simply-hyperlink-nofollow" data-simply-action="simply-hyperlink-nofollow"><i class="fa fa-hand-stop-o"></i>Nofollow</button>
				<button class="simply-hyperlink-newwindow" data-simply-action="simply-hyperlink-newwindow"><i class="fa fa-external-link"></i>New window</button>
				<button class="simply-hyperlink-unlink" data-simply-action="simply-hyperlink-unlink"><i class="fa fa-chain-broken"></i>Remove link</button>
			</div>
		</div>
		<div class="simply-toolbar-section simply-text-align">
			<ul data-type="simply-buttongroup-radio">
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-left"><i class="fa fa-align-left"></i>Left</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-center"><i class="fa fa-align-center"></i>Center</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-right"><i class="fa fa-align-right"></i>Right</button></li>
				<li><button data-simply-action="simply-text-class" data-value="simply-text-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
				<li><button data-simply-action="simply-text-class" data-value="none"><i class="fa fa-times"></i>None</button></li>
			</ul>
		</div>
		<div class="simply-toolbar-section simply-insert">
			<ul>
				<li><button data-simply-action="simply-insert-image" data-simply-section="simply-insert-image"><i class="fa fa-picture-o"></i>Image</button></li>
				<li><button data-simply-action="simply-insert-source" data-simply-section="simply-insert-source"><i class="fa fa-code"></i>Code</button></li>
			</ul>
		</div>
	</div>
</section>
<script type="text/javascript">
	window.setTimeout(function() {
		editor.plugins.text = {};
	}, 3000);

	var initTextToolbar = function(config) {
		var toolbar = document.querySelector("#" + this.name);
		if (typeof config === "object" && toolbar) {
			// Init blockstyles
			if (config.block) {
				var blockStyleSelect = toolbar.querySelector('select[data-simply-action=simply-text-blockstyle]');
				if (blockStyleSelect) {
					if (config.block.length) {
						blockStyleSelect.innerHTML = '';
						for (var i=0; i<config.block.length; i++) {
							option = document.createElement("option");
							option.value = config.block[i].tag;
							option.innerHTML = config.block[i].name;
							blockStyleSelect.appendChild(option);
						}
						option = document.createElement("option");
						option.value = '';
						option.innerHTML = '(plain text)';
						blockStyleSelect.appendChild(option);
					} else {
						blockStyleSelect.style.display = "none";
					}
				}
			}

			// Init inline styles
			if (config.inline) {
				var inlineStyles = toolbar.querySelector('ul.simply-text-inline');
				if (inlineStyles) {
					if (config.inline.length) {
						inlineStyles.innerHTML = '';
						for (var i=0; i<config.inline.length; i++) {
							var item = document.createElement("li");
							var button = document.createElement("button");
							button.setAttribute("data-value", config.inline[i].tag);
							button.setAttribute("data-simply-action", "simply-text-inline");
							button.innerHTML = "<i class='fa " + config.inline[i].icon + "'></i>" + config.inline[i].name;
							item.appendChild(button);
							inlineStyles.appendChild(item);
						}
					} else {
						inlineStyles.style.display = "none";
					}
				}
			}

			// Init block classes
			if (config.class) {
				var classSection = toolbar.querySelector('div.simply-toolbar-section.simply-text-class');
				if (classSection) {
					if (config.class.length) {
						classSection.innerHTML = '';
						for (var i=0; i<config.class.length; i++) {
							if (config.class[i].length) {
								var classList = config.class[i].slice();
								classList.push({class: "none", name: "Default", icon: "fa-times"});
								var list = document.createElement("UL");
								list.setAttribute("data-type", "simply-buttongroup-radio");
								for (var j=0; j<classList.length; j++) {
									var item = document.createElement("li");
									var button = document.createElement("button");
									button.setAttribute("data-value", classList[j].class);	
									button.setAttribute("data-simply-action", "simply-text-class");
									button.innerHTML = "<i class='fa " + classList[j].icon + "'></i>" + classList[j].name;
									item.appendChild(button);
									list.appendChild(item);
								}

								classSection.appendChild(list);
							}
						}
					}
				}
			}
		}
	};

	var updateTextToolbar = function(toolbar) {
		if (toolbar === null) {
			return;
		}
		
		var sel = vdSelectionState.get();
		var parent = vdSelection.getNode(sel);
		var field = editor.node.getEditableField();

		hopeEditor = field.hopeEditor;
		if (!hopeEditor) {
			return;
		}
		editor.context.hopeEditor = hopeEditor;

		hopeEditor.selection.updateRange();

		var range = hopeEditor.selection.getRange();
		hopeEditor.currentRange = range;

		var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

		if (blockAnnotation && (blockAnnotation.range.end == range.start)) {
			var tagName1 = blockAnnotation.tag.split(/ /, 2)[0].toLowerCase();
			var tagName2 = sel.startContainer.tagName;
			if (!tagName2) {
				tagName2 = sel.startContainer.parentElement.tagName;
			}

			tagName2 = tagName2.toLowerCase();
			if (tagName1 != tagName2) {
				blockAnnotation = false;
			}
		}

		if (blockAnnotation) {
			var tagName = blockAnnotation.tag.split(/ /, 2)[0].toLowerCase();
			var foundTag = toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='" + tagName + "']");
			if (foundTag) {
				foundTag.selected = true;
			} else if (tagName == "li") {
				var annotation = hopeEditor.fragment.has(range, "ol");
				if (annotation) {
					toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='ol']").selected = true;
				} else {
					annotation = hopeEditor.fragment.has(range, "ul");
					if (annotation) {
						toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='ul']").selected = true;
					} else {
						toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='']").selected = true;
					}
				}
			} else {
				toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='']").selected = true;
			}
			toolbar.querySelector("[data-simply-section=simply-text-align]").parentNode.style.display = "block";
		} else {
			toolbar.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='']").selected = true;
			toolbar.querySelector("[data-simply-section=simply-text-align]").parentNode.style.display = "none";
		}

		if (toolbar.querySelector(".simply-toolbar-section.simply-text-class ul")) {
			toolbar.querySelector("[data-simply-section='simply-text-class']").parentNode.style.display = "block";
		} else {
			toolbar.querySelector("[data-simply-section='simply-text-class']").parentNode.style.display = "none";
		}

		// Check inline styles;
		var inlineStyles = toolbar.querySelectorAll("[data-simply-action='simply-text-inline']");
		for (var i=0; i<inlineStyles.length; i++) {
			if (hopeEditor.fragment.has(range, inlineStyles[i].getAttribute("data-value"))) {
				inlineStyles[i].classList.add("simply-selected");
			} else {
				inlineStyles[i].classList.remove("simply-selected");
			}
		}

		// Check hyperlink;
		toolbar.querySelector("[data-simply-action=simply-hyperlink-follow]").parentNode.style.display = "none";

		var hyperlink = hopeEditor.fragment.has(range, "a");
		if (hyperlink || (hopeEditor.field.tagName.toLowerCase() === 'a')) {
			toolbar.querySelector("[data-simply-action=simply-hyperlink-follow]").parentNode.style.display = "block";

			var tempNode;
			if (hyperlink) {
				tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
			} else {
				tempNode = hopeEditor.field;
			}
			var hyperlinkHref = tempNode.getAttribute('href');
			simply.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), hyperlinkHref);

			var hyperlinkTitle = tempNode.getAttribute('title');
			simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), hyperlinkTitle);

			var hyperlinkName = tempNode.getAttribute('name');
			simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), hyperlinkName);
			
			var hyperlinkNofollow = toolbar.querySelector("button.simply-hyperlink-nofollow");
			if (hyperlinkNofollow) {
				if (tempNode.getAttribute("rel") && tempNode.getAttribute("rel").match(/nofollow/)) {
					hyperlinkNofollow.classList.add("simply-selected");
				} else {
					hyperlinkNofollow.classList.remove("simply-selected");
				}
			}

			var hyperlinkTargetBlank = toolbar.querySelector("button.simply-hyperlink-newwindow");
			if (hyperlinkTargetBlank) {
				if (tempNode.getAttribute("target") && tempNode.getAttribute("target").match(/_blank/)) {
					hyperlinkTargetBlank.classList.add("simply-selected");
				} else {
					hyperlinkTargetBlank.classList.remove("simply-selected");
				}
			}

			var hyperlinkUnlink = toolbar.querySelector("button.simply-hyperlink-unlink");
			if (hyperlinkUnlink) {
				toolbar.querySelector("button.simply-hyperlink-unlink").style.display = "inline-block";
			}
		} else {
			simply.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), '');
			simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), '');
			simply.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), '');

			var hyperlinkUnlink = toolbar.querySelector("button.simply-hyperlink-unlink");
			if (hyperlinkUnlink) {
				toolbar.querySelector("button.simply-hyperlink-unlink").style.display = "none";
			}

			var hyperlinkNofollow = toolbar.querySelector("button.simply-hyperlink-nofollow");
			if (hyperlinkNofollow) {
				hyperlinkNofollow.classList.remove("simply-selected");
			}

			var hyperlinkTargetBlank = toolbar.querySelector("button.simply-hyperlink-newwindow");
			if (hyperlinkTargetBlank) {
				hyperlinkTargetBlank.classList.remove("simply-selected");
			}
		}

		// Check aligment
		blockAnnotation = hopeEditor.getBlockAnnotation(range.start);
		var textAlign = toolbar.querySelector(".simply-text-align [data-type=simply-buttongroup-radio]");
		if (blockAnnotation && textAlign) {
			var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
			var buttons = textAlign.querySelectorAll("[data-value]");
			simply.widgets.properties.set(textAlign, "none");
			for (var j=0; j<buttons.length; j++) {
				if (tempNode.classList.contains(buttons[j].getAttribute("data-value"))) {
					simply.widgets.properties.set(textAlign, buttons[j].getAttribute("data-value"));
				}
			}

			if (simply.widgets.properties.get(textAlign) != "none") {
				// Set the parent icon for alignment as well;
				var currentIcon = textAlign.querySelector("button.simply-selected i");
				var icons = toolbar.querySelectorAll("button[data-simply-section=simply-text-align] i");
				for (i=0; i<icons.length; i++) {
					icons[i].className = currentIcon.className;
				}
			} else {
				var currentIcon = textAlign.querySelector("button i");
				var icons = toolbar.querySelectorAll("button[data-simply-section=simply-text-align] i");
				for (i=0; i<icons.length; i++) {
					icons[i].className = currentIcon.className;
				}
			}
		}

		var textClasses = toolbar.querySelectorAll(".simply-text-class [data-type=simply-buttongroup-radio]");
		if (blockAnnotation && textClasses) {
			var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
			for (var i=0; i<textClasses.length; i++) {
				var buttons = textClasses[i].querySelectorAll("[data-value]");
				simply.widgets.properties.set(textClasses[i], "none");
				for (var j=0; j<buttons.length; j++) {
					if (tempNode.classList.contains(buttons[j].getAttribute("data-value"))) {
						simply.widgets.properties.set(textClasses[i], buttons[j].getAttribute("data-value"));
					}
				}
			}
		}

		return true;
	}

	editor.plugins.hope = {
		annotation : {
			explode : function(tag) {
				var tempElm = document.createElement("DIV");
				tempElm.innerHTML = "<" + tag + ">";
				var tempNode = tempElm.childNodes[0];

				return tempNode;
			},
			implode : function(node) {
				if (node.className == '') {
					node.removeAttribute("class");
				}
				result = node.tagName.toLowerCase();
				for (i=0; i<node.attributes.length; i++) {
					result += " " + node.attributes[i].name + "=\"" + node.attributes[i].value + "\"";
				}
				return result;
			},
			tagToggle : [],
			apply : function(tag) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;

				var range = hopeEditor.currentRange;
				var annotation = hopeEditor.fragment.has(range, tag);
				if (annotation) {
					if ((annotation.range.start === range.start) && (annotation.range.end === range.end)) {
						hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					} else if (range.start === range.end) {
						hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
					} else {
						hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
						var newRange = hope.range.create(annotation.range.start, range.start);
						hopeEditor.fragment = hopeEditor.fragment.apply(newRange, tag);
						newRange = hope.range.create(range.end, annotation.range.end);
						hopeEditor.fragment = hopeEditor.fragment.apply(newRange, tag);
					}
				} else {
					if (range.start === range.end) {
						var addTag = function(event) {
							var currentRange = hopeEditor.currentRange;
							if (currentRange.start === range.start && currentRange.end === range.end) {
								var rangeLength = event.newValue.length - event.prevValue.length;
								event.preventDefault();

								event.target.textContent = event.newValue;
								hopeEditor.parseHTML();
								hopeEditor.selection.move(rangeLength);
								var newRange = hope.range.create(range.start, range.start + rangeLength);

								for (var i=0; i<editor.plugins.hope.annotation.tagToggle.length; i++) {
									hopeEditor.fragment = hopeEditor.fragment.apply(newRange, editor.plugins.hope.annotation.tagToggle[i]);
								}
								hopeEditor.update();
							}
							hopeEditor.field.removeEventListener("DOMCharacterDataModified", addTag);
							editor.plugins.hope.annotation.tagToggle = [];
						};

						if (editor.plugins.hope.annotation.tagToggle.length === 0) {
							hopeEditor.field.addEventListener("DOMCharacterDataModified", addTag);
							var removeAddTagListener = function() {
								hopeEditor.field.removeEventListener("DOMCharacterDataModified", addTag);
							}
						}

						var index = editor.plugins.hope.annotation.tagToggle.indexOf(tag);
						if (index !== -1) {
							editor.plugins.hope.annotation.tagToggle.splice(index, 1);
						} else {
							editor.plugins.hope.annotation.tagToggle.push(tag);
						}
						if (editor.plugins.hope.annotation.tagToggle.length === 0) {
							hopeEditor.field.removeEventListener("DOMCharacterDataModified", addTag);
						}
					} else {
						hopeEditor.fragment = hopeEditor.fragment.apply(range, tag);
					}
				}
				hopeEditor.update();
			},
			blocks : function(range) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;

				var blocks = [];
				if (range.start != range.end) {
					var noBlockStart = -1;
					for (var i=range.start; i<range.end+1; i++) {
						var blockAnnotation = hopeEditor.getBlockAnnotation(i);
						if (blockAnnotation) {
							if (noBlockStart > -1) {
								blocks.push({
									range : {
										start : noBlockStart,
										end : i
									},
									tag : ""
								});
								noBlockStart = -1;
							}

							if (blocks.indexOf(blockAnnotation) === -1) {
								blocks.push(blockAnnotation);
							}
						} else {
							if (noBlockStart == -1) {
								noBlockStart = i - 1;
							}
						}
					}
				} else {
					blockAnnotation = hopeEditor.getBlockAnnotation(range.start);
					if (blockAnnotation) {
						blocks.push(blockAnnotation);
					} else {
						var sel = window.getSelection();
						range = window.getSelection().getRangeAt(0);
						range.setStart(sel.focusNode,0);
						range.setEnd(sel.focusNode, sel.focusNode.length);
						window.getSelection().removeAllRanges();
						sel.addRange(range);
						hopeEditor.selection.updateRange();
						range = hopeEditor.selection.getRange();
						blocks.push({
							range : range,
							tag : ""
						});
					}
				}
				return blocks;
			}
		}
	};

	editor.addToolbar({
		"name" : "simply-text-cursor",
		"filter" : {
			"sel-collapsed" : true
		},
		update : updateTextToolbar,
		init : initTextToolbar
	});

	editor.addToolbar({
		name : "simply-text-selection",
		filter : {
			"sel-collapsed" : false
		},
		update : updateTextToolbar,
		init : initTextToolbar,
		actions : {
			'simply-text-class' : function(el) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				var range = hopeEditor.currentRange;
				var blocks = editor.plugins.hope.annotation.blocks(range);
				while (blocks.length) {
					block = blocks.shift();
					var tempNode = editor.plugins.hope.annotation.explode(block.tag);
					if (tempNode.classList.contains(el.getAttribute("data-value"))) {
						tempNode.classList.remove(el.getAttribute("data-value"));
					} else {
						var buttons = el.parentNode.parentNode.querySelectorAll("[data-value]");
						for (var i=0; i<buttons.length; i++) {
							tempNode.classList.remove(buttons[i].getAttribute("data-value"));
						}
						if (el.getAttribute("data-value") !== "none") {
							tempNode.classList.add(el.getAttribute("data-value"));
						}
					}
				
					var newValue = editor.plugins.hope.annotation.implode(tempNode);

					if (block.tag != "") {
						hopeEditor.fragment = hopeEditor.fragment.remove(block.range, block.tag);
					}
					hopeEditor.fragment = hopeEditor.fragment.apply(block.range, newValue);
				}
				hopeEditor.update();
			},
			'simply-text-inline' : function(el) {
				editor.plugins.hope.annotation.apply(hopeEditor, el.getAttribute("data-value"));
			},
			// FIXME: These are here for the tests only, tests should be rewritten.
			'simply-text-bold' : function() {
				editor.plugins.hope.annotation.apply(hopeEditor, "strong");
			},
			'simply-text-italic' : function(el) {
				editor.plugins.hope.annotation.apply(hopeEditor, "em");
			},
			'simply-text-underline' : function(el) {
				editor.plugins.hope.annotation.apply(hopeEditor, "u");
			},
			'simply-text-code' : function(el) {
				editor.plugins.hope.annotation.apply(hopeEditor, "code");
			},
			'simply-text-blockstyle' : function(value) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				var range = hopeEditor.currentRange;
				var blocks = editor.plugins.hope.annotation.blocks(range);

				if (value == "ol" || value == "ul") {
					var annotation = hopeEditor.fragment.has(range, "ul");
					if (annotation) {
						hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, "ul");
						hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, value);
						return;
					}

					annotation = hopeEditor.fragment.has(range, "ol");
					if (annotation) {
						hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, "ol");
						hopeEditor.fragment = hopeEditor.fragment.apply(annotation.range, value);
						hopeEditor.update();
						return;

					}

					if (blocks.length === 0) {
						hopeEditor.fragment = hopeEditor.fragment.apply(range, "li");
						hopeEditor.fragment = hopeEditor.fragment.apply(range, value);
						hopeEditor.update();
						return;
					} else {
						// find out the range that will contain all the to-be-created list items;
						var containingRange;
						for (var i=0; i<blocks.length; i++) {
							if (typeof containingRange === "undefined") {
								containingRange = hope.range.create(blocks[i].range.start, blocks[i].range.end);
							} else {
								containingRange = hope.range.create(Math.min(blocks[i].range.start, containingRange.start), Math.max(blocks[i].range.end, containingRange.end));
							}
						}
						if (range.start != range.end) {
							containingRange = hope.range.create(Math.max(containingRange.start, range.start), Math.min(containingRange.end, range.end));
						}
						hopeEditor.fragment = hopeEditor.fragment.apply(containingRange, value);
						hopeEditor.update();
						value = "li";
					}
				}

				if (blocks.length === 0) {
					return editor.plugins.hope.annotation.apply(hopeEditor, value);
				}

				while (blocks.length) {
					var block = blocks.shift();
					var newRange;
					if (range.start != range.end) {
						newRange = hope.range.create(Math.max(block.range.start, range.start), Math.min(block.range.end, range.end));
					} else {
						newRange = hope.range.create(block.range.start, block.range.end);
					}

					if ((newRange.start == block.range.start) && (newRange.end == block.range.end)) {
						var tagName = block.tag.split(" ")[0];
						if (document.querySelector("[data-simply-action='simply-text-blockstyle'] option[value='" + tagName + "']")) {
							hopeEditor.fragment = hopeEditor.fragment.remove(newRange, block.tag);
						}
					}
					var nodeInfo = false;
					if (block.tag.indexOf(" ") !== -1) {
						nodeInfo = block.tag.substr(block.tag.indexOf(" ")+1);
					}
					var newValue = value;
					if (nodeInfo) {
						newValue += " " + nodeInfo;
					}
					if (value) {
						hopeEditor.fragment = hopeEditor.fragment.apply(newRange, newValue);
					}
				}

				hopeEditor.update();
			},
			"simply-hyperlink-href" : function(value) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;

				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					hopeEditor.field.setAttribute("href", value);
					return;
				}

				var range = hopeEditor.currentRange;

				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a href="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("href", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"simply-hyperlink-unlink" : function() {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				var range = hopeEditor.currentRange;
				var hyperlink = hopeEditor.fragment.has(range, "a");
				if (hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.update();
				}
			},
			"simply-hyperlink-title" : function(value) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					hopeEditor.field.setAttribute("title", value);
					return;
				}

				var range = hopeEditor.currentRange;
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a title="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("title", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"simply-hyperlink-name" : function(value) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					hopeEditor.field.setAttribute("name", value);
					return;
				}

				var range = hopeEditor.currentRange;
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a name="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("name", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"simply-hyperlink-nofollow" : function(button) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					if (hopeEditor.field.getAttribute("rel") == "nofollow") {
						hopeEditor.field.removeAttribute("rel");
						button.classList.remove("simply-selected");
					} else {
						hopeEditor.field.setAttribute("rel", "nofollow");
						button.classList.add("simply-selected");
					}
					return;
				}

				var range = hopeEditor.currentRange;
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a rel="nofollow"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);

					if (tempNode.getAttribute("rel") == "nofollow") {
						tempNode.removeAttribute("rel");
						button.classList.remove("simply-selected");
					} else {
						tempNode.setAttribute("rel", "nofollow");
						button.classList.add("simply-selected");
					}
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"simply-hyperlink-newwindow" : function(button) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					if (hopeEditor.field.getAttribute("target") == "_blank") {
						hopeEditor.field.removeAttribute("target");
						button.classList.remove("simply-selected");
					} else {
						hopeEditor.field.setAttribute("target", "_blank");
						button.classList.add("simply-selected");
					}
					return;
				}

				var range = hopeEditor.currentRange;
				var hyperlink = hopeEditor.fragment.has(range, "a");

				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a target="_blank"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);

					if (tempNode.getAttribute("target") == "_blank") {
						tempNode.removeAttribute("target");
						button.classList.remove("simply-selected");
					} else {
						tempNode.setAttribute("target", "_blank");
						button.classList.add("simply-selected");
					}
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"simply-hyperlink-follow" : function(button) {
				var field = editor.context.hopeEditor.field;
				var hopeEditor = field.hopeEditor;
				var target;
				if (hopeEditor.field.tagName.toLowerCase() === 'a') {
					target = hopeEditor.field;
				} else {
					var sel = vdSelectionState.get();
					target = vdSelection.getNode(sel);
					if (target.tagName.toLowerCase() !== 'a') {
						target = target.parentNode;
					}
				}
				muze.event.fire(target, "dblclick");
			}
		}
	});
	editor.addContextFilter("simply-hyperlink", {
		"selector" : "A",
		"parent" : {
			"selector" : "*"
		},
		"context" : "simply-text-selection"
	});
	editor.addContextFilter("simply-textonly", {
		"selector" : "[data-simply-content='text']",
		"context" : "simply-no-context"
	});
</script>