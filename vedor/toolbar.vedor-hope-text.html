<section id="vedor-text-cursor" class="vedor-section">
	<h1>*HTML Toolbar for Text Cursor*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-section="vedor-text-style" class="vedor-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-vedor-section="vedor-text-align" class="vedor-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-vedor-section="vedor-clipboard" class="vedor-expands"><i class="fa fa-clipboard"></i>Clipboard</button></li>
			<li><button data-vedor-section="vedor-insert" class="vedor-expands"><i class="fa fa-plus"></i>Insert</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-text-style">
			<ul>
				<li class="vedor-text-format"><select name="textStyle" data-vedor-action="vedor-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
				</select></li>
				<li class="vedor-text-bold"><button data-vedor-action="vedor-text-bold"><i class="fa fa-bold"></i>Bold</button></li>
				<li class="vedor-text-italic"><button data-vedor-action="vedor-text-italic"><i class="fa fa-italic"></i>Italic</button></li>
				<li class="vedor-text-underline"><button data-vedor-action="vedor-text-underline"><i class="fa fa-underline"></i>Underline</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-text-align" data-type="vedor-buttongroup-radio">
			<ul>
				<li><button data-vedor-action="vedor-text-align-left" data-value="left" class="vedor-align-left"><i class="fa fa-align-left"></i>Left</button></li>
				<li><button data-vedor-action="vedor-text-align-center" data-value="center" class="vedor-align-center"><i class="fa fa-align-center"></i>Center</button></li>
				<li><button data-vedor-action="vedor-text-align-right" data-value="right" class="vedor-align-right"><i class="fa fa-align-right"></i>Right</button></li>
				<li><button data-vedor-action="vedor-text-align-justify" data-value="justify" class="vedor-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
				<li><button data-vedor-action="vedor-text-align-none" data-value="none" class="vedor-align-none"><i class="fa fa-minus-circle"></i>None</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-insert">
			<ul>
				<li><button data-vedor-action="vedor-insert-image" data-vedor-section="vedor-insert-image"><i class="fa fa-picture-o"></i>Image</button></li>
				<!-- li><button data-vedor-action="vedor-insert-table" data-vedor-section="vedor-insert-table"><i class="fa fa-table"></i>Table
					<div id="vdTablePopup" style="display: none;" unselectable="on">
						<div id="vdTablePreview" unselectable="on">
						</div>
						<div id="vdTableText" unselectable="on">
						</div>
					</div>
				</button></li -->
				<!-- li><button data-vedor-action="vedor-insert-symbol" data-vedor-section="vedor-insert-symbol"><i class="fa fa-eur"></i>Symbol</button></li -->
				<!-- li><button data-vedor-action="vedor-insert-gadget" data-vedor-section="vedor-insert-gadget"><i class="fa fa-puzzle-piece"></i>Gadget</button></li -->
				<li><button data-vedor-action="vedor-insert-source" data-vedor-section="vedor-insert-source"><i class="fa fa-code"></i>Code</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-clipboard">
			<ul>
				<li><button class="vedor-clipboard-paste"><i class="fa fa-clipboard"></i>Paste</button></li>
				<li><button class="vedor-clipboard-select-all" data-vedor-action="vedor-clipboard-select-all"><i class="fa fa-arrows-alt"></i>Select all</button></li>
			</ul>
		</div>
	</div>
</section>
<section id="vedor-text-selection" class="vedor-section">
	<h1>*HTML Toolbar for Text Selection*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-section="vedor-text-style" class="vedor-expands"><i class="fa fa-magic"></i>Style</button></li>
			<li><button data-vedor-section="vedor-text-align" class="vedor-expands"><i class="fa fa-align-left"></i>Align</button></li>
			<li><button data-vedor-section="vedor-clipboard" class="vedor-expands"><i class="fa fa-clipboard"></i>Clipboard</button></li>
			<li><button data-vedor-section="vedor-hyperlink" class="vedor-expands"><i class="fa fa-link"></i>Link</button></li>
			<li><button data-vedor-section="vedor-code" data-vedor-action="vedor-edit-source"><i class="fa fa-code"></i>Code</button></li>
		</ul>
		<div class="vedor-toolbar-section vedor-text-style">
			<ul>
				<li class="vedor-text-format"><select name="textStyle" data-vedor-action="vedor-text-blockstyle">
					<option value="h1">Heading 1</option>
					<option value="h2">Heading 2</option>
					<option value="h3">Heading 3</option>
					<option value="p">Paragraph</option>
				</select></li>
				<li class="vedor-text-bold"><button data-vedor-action="vedor-text-bold"><i class="fa fa-bold"></i>Bold</button></li>
				<li class="vedor-text-italic"><button data-vedor-action="vedor-text-italic"><i class="fa fa-italic"></i>Italic</button></li>
				<li class="vedor-text-underline"><button data-vedor-action="vedor-text-underline"><i class="fa fa-underline"></i>Underline</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-hyperlink">
			<div><label>URL</label><input type="text" id="vdHyperlinkHref" data-vedor-action="vedor-hyperlink-href"></div>
			<div><label>Title</label><input type="text" id="vdHyperlinkTitle" data-vedor-action="vedor-hyperlink-title"></div>
			<div><label>Name</label><input type="text" id="vdHyperlinkName" data-vedor-action="vedor-hyperlink-name"></div>
			<div><button class="vedor-hyperlink-nofollow" data-vedor-action="vedor-hyperlink-nofollow"><i class="fa fa-chain-broken"></i>Nofollow</button></div>
		</div>
		<div class="vedor-toolbar-section vedor-text-align" data-type="vedor-buttongroup-radio">
			<ul>
				<li><button data-vedor-action="vedor-text-align-left" data-value="left" class="vedor-align-left"><i class="fa fa-align-left"></i>Left</button></li>
				<li><button data-vedor-action="vedor-text-align-center" data-value="center" class="vedor-align-center"><i class="fa fa-align-center"></i>Center</button></li>
				<li><button data-vedor-action="vedor-text-align-right" data-value="right" class="vedor-align-right"><i class="fa fa-align-right"></i>Right</button></li>
				<li><button data-vedor-action="vedor-text-align-justify" data-value="justify" class="vedor-align-justify"><i class="fa fa-align-justify"></i>Justify</button></li>
				<li><button data-vedor-action="vedor-text-align-none" data-value="none" class="vedor-align-none"><i class="fa fa-minus-circle"></i>None</button></li>
			</ul>
		</div>
		<div class="vedor-toolbar-section vedor-clipboard">
			<ul>
				<li><button class="vedor-clipboard-cut"><i class="fa fa-scissors"></i>Cut</button></li>
				<li><button class="vedor-clipboard-copy"><i class="fa fa-files-o"></i>Copy</button></li>
				<li><button class="vedor-clipboard-paste"><i class="fa fa-clipboard"></i>Paste</button></li>
				<li><button class="vedor-clipboard-select-all" data-vedor-action="vedor-clipboard-select-all"><i class="fa fa-arrows-alt"></i>Select all</button></li>
			</ul>
		</div>
	</div>
</section>
<script type="text/javascript">
	window.setTimeout(function() {
		editor.plugins.text = {};
	}, 3000);

	var updateTextToolbar = function(toolbar) {
		var sel = vdSelectionState.get();
		var parent = vdSelection.getNode(sel);
		var field = editor.node.getEditableField(parent);

		hopeEditor = field.hopeEditor;

		hopeEditor.selection.updateRange();

		var range = hopeEditor.selection.getRange();

		var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

		if (blockAnnotation) {
			var tagName = blockAnnotation.tag.split(/ /, 2)[0].toLowerCase();
			var foundTag = toolbar.querySelector("[name='textStyle'] option[value='" + tagName + "']");
			if (foundTag) {
				foundTag.selected = true;
			} else {
				toolbar.querySelector("[name='textStyle'] option[value='p']").selected = true;
			}
		} else {
			toolbar.querySelector("[name='textStyle'] option[value='p']").selected = true;
		}


		// Check "Bold"
		var textBold = toolbar.querySelector(".vedor-text-bold button");
		if (hopeEditor.fragment.has(range, "strong")) {
			textBold.classList.add("vedor-selected");
		} else {
			textBold.classList.remove("vedor-selected");
		}

		// Check "Italic"
		var textItalic = toolbar.querySelector(".vedor-text-italic button");
		if (hopeEditor.fragment.has(range, "em")) {
			textItalic.classList.add("vedor-selected");
		} else {
			textItalic.classList.remove("vedor-selected");
		}

		// Check "Underline"
		var textUnderline = toolbar.querySelector(".vedor-text-underline button");
		if (hopeEditor.fragment.has(range, "u")) {
			textUnderline.classList.add("vedor-selected");
		} else {
			textUnderline.classList.remove("vedor-selected");
		}

		// Check hyperlink;
		var hyperlink = hopeEditor.fragment.has(range, "a");
		if (hyperlink) {
			var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);

			var hyperlinkHref = tempNode.getAttribute('href');
			vedor.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), hyperlinkHref);

			var hyperlinkTitle = tempNode.getAttribute('title');
			vedor.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), hyperlinkTitle);

			var hyperlinkName = tempNode.getAttribute('name');
			vedor.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), hyperlinkName);
			
			var hyperlinkNofollow = toolbar.querySelector("button.vedor-hyperlink-nofollow");
			if (hyperlinkNofollow) {
				if (tempNode.getAttribute("rel") && tempNode.getAttribute("rel").match(/nofollow/)) {
					hyperlinkNofollow.classList.add("vedor-selected");
				} else {
					hyperlinkNofollow.classList.remove("vedor-selected");
				}
			}
		} else {
			vedor.widgets.properties.set(toolbar.querySelector("#vdHyperlinkHref"), '');
			vedor.widgets.properties.set(toolbar.querySelector('#vdHyperlinkTitle'), '');
			vedor.widgets.properties.set(toolbar.querySelector('#vdHyperlinkName'), '');
			
			var hyperlinkNofollow = toolbar.querySelector("button.vedor-hyperlink-nofollow");
			if (hyperlinkNofollow) {
				hyperlinkNofollow.classList.remove("vedor-selected");
			}
		}

		// Check aligment
		blockAnnotation = hopeEditor.getBlockAnnotation(range.start);
		var textAlign = toolbar.querySelector(".vedor-text-align[data-type=vedor-buttongroup-radio]");
		if (blockAnnotation && textAlign) {
			var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
			if (tempNode.classList.contains("vedor-text-align-left")) {
				vedor.widgets.properties.set(textAlign, "left");
			} else if (tempNode.classList.contains("vedor-text-align-right")) {
				vedor.widgets.properties.set(textAlign, "right");
			} else if (tempNode.classList.contains("vedor-text-align-center")) {
				vedor.widgets.properties.set(textAlign, "center");
			} else if (tempNode.classList.contains("vedor-text-align-justify")) {
				vedor.widgets.properties.set(textAlign, "justify");
			} else {
				vedor.widgets.properties.set(textAlign, "none");
			}

			if (vedor.widgets.properties.get(textAlign) != "none") {
				// Set the parent icon for alignment as well;
				var currentIcon = toolbar.querySelector("div.vedor-text-align button.vedor-selected i");
				var icons = toolbar.querySelectorAll("button[data-vedor-section=vedor-text-align] i");
				for (i=0; i<icons.length; i++) {
					icons[i].className = currentIcon.className;
				}
			} else {
				var currentIcon = toolbar.querySelector("div.vedor-text-align button i");
				var icons = toolbar.querySelectorAll("button[data-vedor-section=vedor-text-align] i");
				for (i=0; i<icons.length; i++) {
					icons[i].className = currentIcon.className;
				}
			}
		}

		return true;
	}

	editor.plugins.hope = {
		annotation : {
			explode : function(tag) {
				var tempElm = document.createElement("DIV");
				tempElm.innerHTML = "<" + tag + ">";
				var tempNode = tempElm.childNodes[0];

				return tempNode;
			},
			implode : function(node) {
				if (node.className == '') {
					node.removeAttribute("class");
				}
				result = node.tagName.toLowerCase();
				for (i=0; i<node.attributes.length; i++) {
					result += " " + node.attributes[i].name + "=\"" + node.attributes[i].value + "\"";
				}
				return result;
			}
		}
	};

	editor.addToolbar({
		"name" : "vedor-text-cursor",
		"filter" : {
			"sel-collapsed" : true
		},
		update : updateTextToolbar
	});

	editor.addToolbar({
		name : "vedor-text-selection",
		filter : {
			"sel-collapsed" : false
		},
		update : updateTextToolbar,
		actions : {
			'vedor-text-bold' : function() {
				var range = hopeEditor.selection.getRange();
				console.log(range);
				var annotation = hopeEditor.fragment.has(range, "strong");
				console.log(annotation);
				if (annotation) {
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
				} else {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, "strong");
					console.log(hopeEditor.fragment);

				}
				hopeEditor.update();
			},
			'vedor-text-italic' : function(el) {
				var range = hopeEditor.selection.getRange();
				var annotation = hopeEditor.fragment.has(range, "em");
				if (annotation) {
					hopeEditor.fragment = hopeEditor.fragment.remove(annotation.range, annotation.tag);
				} else {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, "em");
				}
				hopeEditor.update();
			},
			'vedor-text-underline' : function() {
				var range = hopeEditor.selection.getRange();
				hopeEditor.fragment = hopeEditor.fragment.toggle(range, "u");
				hopeEditor.update();
			},
			'vedor-text-align-left' : function() {
				var range = hopeEditor.selection.getRange();
				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
				if (tempNode.classList.contains("vedor-text-align-left")) {
					tempNode.classList.remove("vedor-text-align-left");
				} else {
					tempNode.classList.remove("vedor-text-align-center");
					tempNode.classList.remove("vedor-text-align-justify");
					tempNode.classList.remove("vedor-text-align-right");

					tempNode.classList.add("vedor-text-align-left");
				}
				
				var newValue = editor.plugins.hope.annotation.implode(tempNode);

				hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
				hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);
				hopeEditor.update();
			},
			'vedor-text-align-right' : function() {
				var range = hopeEditor.selection.getRange();
				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
				if (tempNode.classList.contains("vedor-text-align-right")) {
					tempNode.classList.remove("vedor-text-align-right");
				} else {
					tempNode.classList.remove("vedor-text-align-left");
					tempNode.classList.remove("vedor-text-align-justify");
					tempNode.classList.remove("vedor-text-align-center");

					tempNode.classList.add("vedor-text-align-right");
				}
				
				var newValue = editor.plugins.hope.annotation.implode(tempNode);

				hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
				hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);

				hopeEditor.update();
			},
			'vedor-text-align-center' : function() {
				var range = hopeEditor.selection.getRange();
				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
				if (tempNode.classList.contains("vedor-text-align-center")) {
					tempNode.classList.remove("vedor-text-align-center");
				} else {
					tempNode.classList.remove("vedor-text-align-left");
					tempNode.classList.remove("vedor-text-align-justify");
					tempNode.classList.remove("vedor-text-align-right");

					tempNode.classList.add("vedor-text-align-center");
				}
				
				var newValue = editor.plugins.hope.annotation.implode(tempNode);

				hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
				hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);
				hopeEditor.update();
			},
			'vedor-text-align-justify' : function() {
				var range = hopeEditor.selection.getRange();
				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
				if (tempNode.classList.contains("vedor-text-align-justify")) {
					tempNode.classList.remove("vedor-text-align-justify");
				} else {
					tempNode.classList.remove("vedor-text-align-left");
					tempNode.classList.remove("vedor-text-align-right");
					tempNode.classList.remove("vedor-text-align-center");

					tempNode.classList.add("vedor-text-align-justify");
				}
				
				var newValue = editor.plugins.hope.annotation.implode(tempNode);

				hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
				hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);
				hopeEditor.update();
			},
			'vedor-text-align-none' : function() {
				var range = hopeEditor.selection.getRange();
				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				var tempNode = editor.plugins.hope.annotation.explode(blockAnnotation.tag);
				tempNode.classList.remove("vedor-text-align-justify");
				tempNode.classList.remove("vedor-text-align-left");
				tempNode.classList.remove("vedor-text-align-right");
				tempNode.classList.remove("vedor-text-align-center");

				var newValue = editor.plugins.hope.annotation.implode(tempNode);

				hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
				hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);
				hopeEditor.update();
			},
			'vedor-text-blockstyle' : function(value) {
				var range = hopeEditor.selection.getRange();

				var blockAnnotation = hopeEditor.getBlockAnnotation(range.start);

				if (!blockAnnotation) {
					var sel = window.getSelection();
					range = window.getSelection().getRangeAt(0);
					range.setStart(sel.focusNode,0);
					range.setEnd(sel.focusNode, sel.focusNode.length);
					window.getSelection().removeAllRanges();
					sel.addRange(range);
					hopeEditor.selection.updateRange();
					range = hopeEditor.selection.getRange();
					hopeEditor.fragment = hopeEditor.fragment.apply(hopeEditor.selection.getRange(), value);
				} else { 
					var nodeInfo = blockAnnotation.tag.split(/ /, 2);
					var newValue = value;
					if (nodeInfo[1]) {
						newValue += " " + nodeInfo[1];
					}
					hopeEditor.fragment = hopeEditor.fragment.remove(blockAnnotation.range, blockAnnotation.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(blockAnnotation.range, newValue);
				}

				hopeEditor.update();
			},
			"vedor-hyperlink-href" : function(value) {
				var range = hopeEditor.selection.getRange();
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a href="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("href", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"vedor-hyperlink-title" : function(value) {
				var range = hopeEditor.selection.getRange();
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a title="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("title", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"vedor-hyperlink-name" : function(value) {
				var range = hopeEditor.selection.getRange();
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a name="' + value + '"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);
					tempNode.setAttribute("name", value);
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			},
			"vedor-hyperlink-nofollow" : function(button) {
				var range = hopeEditor.selection.getRange();
				var hyperlink = hopeEditor.fragment.has(range, "a");
				
				if (!hyperlink) {
					hopeEditor.fragment = hopeEditor.fragment.apply(range, 'a rel="nofollow"');
				} else {
					var tempNode = editor.plugins.hope.annotation.explode(hyperlink.tag);

					if (tempNode.getAttribute("rel") == "nofollow") {
						tempNode.removeAttribute("rel");
						button.classList.remove("vedor-selected");
					} else {
						tempNode.setAttribute("rel", "nofollow");
						button.classList.add("vedor-selected");
					}
					var newValue = editor.plugins.hope.annotation.implode(tempNode);
					hopeEditor.fragment = hopeEditor.fragment.remove(hyperlink.range, hyperlink.tag);
					hopeEditor.fragment = hopeEditor.fragment.apply(hyperlink.range, newValue);
				}
				hopeEditor.update();
			}
		}
	});
	editor.addContextFilter("vedor-hyperlink", {
		"selector" : "A",
		"parent" : {
			"selector" : "*"
		},
		"context" : "vedor-text-selection"
	});
	editor.addContextFilter("vedor-textonly", {
		"selector" : "[data-vedor-content='text']",
		"context" : "vedor-no-context"
	});
</script>