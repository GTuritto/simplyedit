<section id="simply-htmlsource" class="simply-dialog">
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-htmlsource-selectall"><i class="fa fa-quote-right"></i>Select field</button></li>
			<li><button data-simply-action="simply-htmlsource-editable"><i class="fa fa-lock"></i>Source is static</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-close"><i class="fa fa-times"></i>Cancel</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-fullscreen"><i class="fa fa-expand"></i>Full screen</button></li>
		</ul>
	</div>
	<div class="simply-dialog-body">
		<div class="vdYellowAlert" id="vdInsertHTMLWarning" style="display: none;">
			Warning: editable source and javascript do not mix.
		</div>
		<textarea id="vdInsertHTMLSource"></textarea>
	</div>
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li class='simply-right'><button data-simply-action="simply-htmlsource-insert"><i class="fa fa-check"></i>Insert</button></li>
		</ul>
	</div>
</section>
<style type="text/css">
	#simply-htmlsource {
		top: 50%;
		height: 400px;
		max-height: 80%;
		margin-top: -200px;

		left: 50%;
		width: 480px;
		margin-left: -240px;
	}
	#simply-htmlsource .simply-dialog-body {
		background-color: #eee;
	}
	#simply-htmlsource.fullscreen {
		top: 0px;
		bottom: 0px;
		left: 0px;
		right: 0px;
		max-width: 100%;
		max-height: 100%;
		height: auto;
		width: auto;
		margin-left: 0px;
		margin-top: 0px;
	}

	#simply-htmlsource textarea {
		width: 100%;
		height: 100%;
		border: 1px solid #9F9F9F;
		background-color: white;
		box-sizing: border-box;
	}
	#vdInsertHTMLWarning {
		background-color: #FFFFCC;
		border: 1px solid black;
		padding: 2px;
		clear: both;
		height: 32px;
		overflow: hidden;
	}
	@media (max-width: 481px) {
		#simply-htmlsource {
			top: 0px;
			bottom: 0px;
			left: 0px;
			right: 0px;
			max-width: 100%;
			max-height: 100%;
			height: auto;
			width: auto;
			margin-left: 0px;
			margin-top: 0px;
		}
		#simply-htmlsource [data-simply-action="simply-htmlsource-fullscreen"] {
			display: none;
		}
	}
</style>
<script>
	editor.plugins.htmlsource = {
		currentField : null,
		currentSel : null,
		selectAll : function() {
			var element = editor.plugins.htmlsource.currentField;
			var sel = vdSelectionState.get();
			vdSelection.selectNode(sel, element);
			vdSelectionState.save(sel);
			vdSelectionState.selectAll = true;
			editor.plugins.htmlsource.dialog.setSource();
		},
		getSourceSpan : function() {
			var parent=false;
			var sel = vdSelectionState.get();
			if (sel) {
				parent = vdSelection.getNode(sel);
				while (parent && (parent.tagName=='DIV' || parent.tagName=='SPAN') && parent.parentNode && !parent.getAttribute('data-simply-htmlsource')) {
					parent=parent.parentNode;
				}
				if (!parent || (parent.tagName!='DIV' && parent.tagName!='SPAN') || !parent.getAttribute('data-simply-htmlsource')) {
					parent=false;
				}
			}
			return parent;
		},
		get : function() {
			var span = editor.plugins.htmlsource.getSourceSpan();
			if (span) {
				return simply.util.base64.decode(span.getAttribute('data-simply-htmlsource'));
			} else {
				var sel = vdSelectionState.get();
				return vdSelection.getHTMLText(sel);
			}
		},
		dialog : {
			setSource : function() {
				var source = editor.plugins.htmlsource.get();
				document.getElementById('vdInsertHTMLSource').value = source;

				var span = editor.plugins.htmlsource.getSourceSpan();
				var button = document.querySelector("[data-simply-action=simply-htmlsource-editable]");
				if (span) {
					button.classList.add("simply-selected");
				} else {
					button.classList.remove("simply-selected");
				}
				document.getElementById('vdInsertHTMLSource').select();

				var fullscreen = document.querySelector("[data-simply-action=simply-dialog-fullscreen]");
				if (document.getElementById('simply-htmlsource').classList.contains("fullscreen")) {
					fullscreen.classList.add("simply-selected");
				} else {
					fullscreen.classList.remove("simply-selected");
				}
			},
			open : function() {
				editor.plugins.htmlsource.currentSel = vdSelectionState.get().cloneRange();
				editor.plugins.htmlsource.currentField = editor.node.getEditableField();
				vdSelectionState.save(editor.plugins.htmlsource.currentSel);

				editor.plugins.dialog.open(document.getElementById('simply-htmlsource'), editor.plugins.htmlsource.dialog.setSource);
				editor.plugins.htmlsource.dialog.setWarning();

				vdSelectionState.selectAll = false;
				vdSelectionState.selectedElement = false;
			},
			setWarning : function() {
				var button = document.querySelector("[data-simply-action=simply-htmlsource-editable]");
				if (button && button.classList.contains("simply-selected")) {
					document.getElementById('vdInsertHTMLWarning').style.display='block';
				} else {
					document.getElementById('vdInsertHTMLWarning').style.display='none';
				}
			},
			fullscreen : function() {
				var fullscreen = document.querySelector("[data-simply-action=simply-htmlsource-fullscreen]");
				if (document.getElementById('simply-htmlsource').classList.contains("fullscreen")) {
					fullscreen.classList.remove("simply-selected");
					document.getElementById('simply-htmlsource').classList.remove("fullscreen");
				} else {
					fullscreen.classList.add("simply-selected");
					document.getElementById('simply-htmlsource').classList.add("fullscreen");
				}
			}
		},
		tidy : function(html) {
			var d = document.createElement('div');
			d.innerHTML = html;
			return d.innerHTML;
		},
		insert : function() {
			var source = document.getElementById('vdInsertHTMLSource').value;
			var tidySource = editor.plugins.htmlsource.tidy(source);
			if (tidySource != source) {
				if (confirm("The HTML content does not seem valid and cannot be inserted. Correct it automatically?")) {
					document.getElementById('vdInsertHTMLSource').value = tidySource;
				}
				return;
			}

			var field=editor.plugins.htmlsource.currentField;
			if (field) {
				var button = document.querySelector("[data-simply-action=simply-htmlsource-editable]");
				if (button && button.classList.contains("simply-selected")) {
					var encodedsource = simply.util.base64.encode(source); // this makes sure IE doesn't touch the sourcecode.
					source = '<div data-simply-htmlsource="'+encodedsource+'" contenteditable="false">'+source+'</div>';
				}
				if (vdSelectionState.selectAll) {
					field.innerHTML = source;
				} else {
					if (!editor.plugins.htmlsource.currentSel.collapsed) {
						vdSelectionState.restore(editor.plugins.htmlsource.currentSel);
						document.execCommand('delete'); // this is somehow needed to trick IE into breaking potential <P>'s into 2
					}
					vdSelection.setHTMLText(editor.plugins.htmlsource.currentSel, source);
				}
			}

			if (editor.plugins.htmlsource.currentField.hopeEditor) {
				editor.plugins.htmlsource.currentField.hopeEditor.parseHTML();
			}

			vdSelectionState.selectAll = false;
			editor.plugins.htmlsource.currentField = false;
			editor.plugins.dialog.close();
		}
	};

	editor.addAction("simply-insert-source", editor.plugins.htmlsource.dialog.open);
	editor.addAction("simply-edit-source", editor.plugins.htmlsource.dialog.open);
	editor.addAction("simply-htmlsource-selectall", editor.plugins.htmlsource.selectAll);
	editor.addAction("simply-htmlsource-insert", editor.plugins.htmlsource.insert);
</script>
