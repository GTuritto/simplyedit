<section id="vedor-list-item" class="vedor-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-list-item-delete"><i class="fa fa-times"></i>Delete</button></li>
			<li><button data-vedor-action="vedor-list-item-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
	</div>
</section>
<section id="vedor-list" class="vedor-section">
	<h1>*Objectlist Toolbar*</h1>
	<div class="vedor-toolbar">
		<ul class="vedor-buttons">
			<li><button data-vedor-action="vedor-list-add"><i class="fa fa-plus-circle"></i>Add</button></li>
		</ul>
	</div>
</section>
<script>
	var currentList, currentListItem;

	editor.plugins.list = {
		item : {
			add : function() {
				var targetNode = currentListItem;
				
				var targetObjectList = targetNode.parentNode;
				if (targetObjectList.getAttribute("data-vedor-list")) {
					var template = editor.plugins.list.getHtmlTemplate(targetObjectList);
					editor.plugins.list.insertTemplate(targetObjectList, template);
				}
			},
			delete : function() {
				var targetNode = currentListItem;
				var objectList = targetNode.parentNode;
				objectList.removeChild(targetNode);
				
				if (!objectList.querySelector("[data-vedor-list-item]")) {
					objectList.classList.add("vedor-empty");
				}
				
				// FIXME: De selectie blijft toch staan, wat niet goed is;
				vdSelectionState.remove();
				editor.context.update();
				
				// FIXME: register change stond hier;
			}
		},
		add : function() {
			var targetObjectList = currentList;

			if (targetObjectList.getAttribute("data-vedor-list")) {
				var tempate = editor.plugins.list.getHtmlTemplate(targetObjectList);
				editor.plugins.list.insertTemplate(targetObjectList, template);
			}
		},
		insertTemplate : function(list, templateName) {
			var template = list.templates[templateName];
			if (template) {
				var newNode = document.importNode(template.content, true);
				editor.editmode.editable(newNode);
				newNode.firstElementChild.dataset.vedorTemplate = templateName;
				newNode.firstElementChild.dataset.vedorListItem = true;

				var listItems = list.querySelectorAll("[data-vedor-list-item]");
				if (listItems.length) {
					list.insertBefore(newNode.children[0], listItems[listItems.length-1].nextSibling);
				} else {
					list.insertBefore(newNode.children[0], list.firstElementChild);
				}
				list.classList.remove("vedor-empty");
				list.appendChild(newNode);
			}
		},
		getHtmlTemplate : function(list) {
			var templateName = Object.keys(list.templates)[0];

			if (Object.keys(list.templates).length > 1) {
				alert('multiple templates possible');
				templateName = Object.keys(list.templates)[prompt("Template number?")];
			}

			return templateName;
		}
	};

	editor.addToolbar({
		name: 'vedor-list-item',
		filter:{
			"selector" : "[data-vedor-list-item]"
			/*"parent" : {
				"selector" : "[data-vedor-list]"
			}*/
		},
		actions: {
			"vedor-list-item-add" : editor.plugins.list.item.add,
			"vedor-list-item-delete" : editor.plugins.list.item.delete
		},
		update : function(el) {
			currentListItem = vdSelection.getNode(vdSelectionState.get());
			// console.log("update vedor-list toolbar");
		}
	});
	
	editor.addToolbar({
		name: 'vedor-list',
		filter:{
			"selector" : "[data-vedor-list]"
			/*"parent" : {
				"selector" : "[data-vedor-list]"
			}*/
		},
		init: function() {
			var objectLists = document.querySelectorAll("[data-vedor-list]");
			var keyDownHandler = function(evt) {
				if(evt.ctrlKey && evt.altKey && evt.keyCode == 65) { // ctrl-alt-A
					editor.plugins.list.add(this);
					evt.preventDefault();
				}
			};

			for (var i=0; i<objectLists.length; i++) {
				if (!objectLists[i].querySelector("[data-vedor-list-item]")) {
					objectLists[i].classList.add("vedor-empty");
				}
				objectLists[i].addEventListener("keydown", keyDownHandler);
			}

		},
		actions: {
			"vedor-list-add" : editor.plugins.list.add
		},
		update : function(el) {
			currentListItem = vdSelection.getNode(vdSelectionState.get());
			// console.log("update vedor-list toolbar");
		}
	});	
</script>