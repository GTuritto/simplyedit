<script type="text/javascript">
	var spanListener = function(ev) {
		if (ev.target.tagName=='SPAN') {
			editor.node.unwrap(ev.target);
			var sel = window.getSelection();
			var range = sel.getRangeAt(0);
			sel.removeAllRanges();
			sel.addRange(range);
		}
	};

	var divListener = function(ev) {
		if (ev.target.tagName=='DIV') {
			var sel = window.getSelection();

			var newP = document.createElement("p");
			newP.innerHTML = ev.target.innerHTML;
			ev.target.innerHTML = '';
			ev.target.appendChild(newP);
			if (newP.innerHTML == '') {
				newP.innerHTML = "<br>";
			}

			editor.node.unwrap(ev.target);
			window.setTimeout(function() {
				var range = document.createRange();
				range.setStart(newP, 0);
				sel.removeAllRanges();
				sel.addRange(range);
			}, 10);

		}
	}

	editor.addToolbar({
		name : 'simply-paste-handler',
		init : function() {
			document.addEventListener("keydown", function(event) {
				if (
					editor.toolbar.getSectionEl(event.target) ||
					editor.toolbar.getDialogEl(event.target)
				) {
					return true;
				}

				switch (event.keyCode) {
					case 8:		// backspace
					case 46: 	// delete
						event.target.ownerDocument.addEventListener("DOMNodeInserted", spanListener);
					break;
					case 13:	// enter
						event.target.ownerDocument.addEventListener("DOMNodeInserted", divListener);
					break;
				}
			});

			document.addEventListener("keyup", function(event) {
				if (
					editor.toolbar.getSectionEl(event.target) ||
					editor.toolbar.getDialogEl(event.target)
				) {
					return true;
				}

				event.target.ownerDocument.removeEventListener("DOMNodeInserted", spanListener);
				event.target.ownerDocument.removeEventListener("DOMNodeInserted", divListener);
			});

			document.addEventListener("paste", function(event) {
				if (
					editor.toolbar.getSectionEl(event.target) ||
					editor.toolbar.getDialogEl(event.target)
				) {
					return true;
				}

				var pastedText = undefined;
				var pastedHtml = undefined;
					
				// No IE support is needed, since only webkit/chrome is broken.
				if (event.clipboardData && event.clipboardData.getData) {
					pastedText = event.clipboardData.getData('text/plain');
					pastedHtml = event.clipboardData.getData('text/html');
				}

				event.target.ownerDocument.addEventListener("DOMNodeInserted", spanListener);
						
				if (pastedHtml) {
					var tempNode = event.target.ownerDocument.createElement("DIV");
					tempNode.innerHTML = pastedHtml;
				
					// Remove the startfragment and endfragment bits;
					for (var i=tempNode.childNodes.length-1; i>-1; i--) {
						if (tempNode.childNodes[i].nodeType == 8) {
							if ((tempNode.childNodes[i].data == "StartFragment") || (tempNode.childNodes[i].data == "EndFragment")) {
								tempNode.removeChild(tempNode.childNodes[i]);
							}
						}
					}
				
					// Remove inline styles;
					var tempNodes = tempNode.querySelectorAll("*");
					for (var i=0; i<tempNodes.length; i++) {
						tempNodes[i].removeAttribute("style", '');
					}
					event.preventDefault();

					event.target.ownerDocument.execCommand("insertHtml", false, tempNode.innerHTML);
					event.target.ownerDocument.removeEventListener("DOMNodeInserted", spanListener);
						
					return false;
				}
				if (pastedText) {
					event.preventDefault();
					event.target.ownerDocument.execCommand("insertText", false, pastedText);
					event.target.ownerDocument.removeEventListener("DOMNodeInserted", spanListener);
				}
			});
		}
	});
</script>