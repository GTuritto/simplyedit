<section id="simply-image-browse" class="simply-dialog simply-modal">
	<div class="simply-toolbar">
		<ul class="simply-buttons">
			<li><button data-simply-action="simply-image-browse-filter-same-size"><i class="fa fa-filter"></i>Same size only</button></li>
			<li><button data-simply-action="simply-image-browse-upload"><i class="fa fa-upload"></i>Upload</button><input type="file" multiple accept="image/*"></li>
			<li><button data-simply-action="simply-image-browse-add-folder"><i class="fa fa-plus-square"></i>Add folder</button></li>
			<li><button data-simply-action="simply-image-browse-delete"><i class="fa fa-trash"></i>Delete</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-close"><i class="fa fa-times"></i>Cancel</button></li>
			<li class='simply-right'><button data-simply-action="simply-dialog-fullscreen"><i class="fa fa-expand"></i>Full screen</button></li>
		</ul>
	</div>
	<div class="simply-dialog-body">
	</div>
</section>
<style type="text/css">
	#simply-image-browse .simply-dialog-body > button,
	#simply-image-browse .simply-add-folder {
		border: 1px solid #eee;
		background-color: white;
		height: 149px;
		width: 149px;
		font-family: inherit;
		font-size: 20px;
		position: relative;
		padding: 5px;
		color: #999 !important;
		display: inline-block;
		vertical-align: top;
	}

	#simply-image-browse .simply-add-folder {
		box-sizing: border-box;
		padding-top: 38px;
	}

	#simply-image-browse .simply-add-folder input {
		width: 133px;
		color: #333;
	}

	#simply-image-browse input[type="file"] {
		display: none;
	}
	#simply-image-browse .simply-dialog-body > button:before {
		display: block;
		content: '';
		position: absolute;
		top: 0px;
		left: 0px;
		height: 100%;
		width: 100%;
	}
        #simply-image-browse .simply-dialog-body > button i,
	#simply-image-browse .simply-add-folder > i {
		font-size: 48px;
		display: block;
		width: 100%;
		text-align: center;
	}
	#simply-image-browse .simply-add-folder > button.simply-add {
		color: #333;
		background-color: #eee;
		position: absolute;
		bottom: 5px;
		left: 5px;
		padding: 3px 10px 3px 6px;
		border: 1px solid #999
	}
	#simply-image-browse .simply-add-folder > button.simply-cancel {
		color: #666;
		position: absolute;
		bottom: 5px;
		right: 5px;
		border: 0px;
		background-color: white;
		font-size: 18px;
	}
	#simply-image-browse .simply-add-folder > button.simply-add > i {
		margin-right: 5px;
	}
	#simply-image-browse .simply-dialog-body > button img {
		max-width: 100%;
		max-height: 100%;
		width: 149px;
	}

	#simply-image-browse .simply-dialog-body > button progress {
		width: 100%;
		height: 10px;
	}

	#simply-image-browse .simply-dialog-body > button i.select {
		position: absolute;
		top: 0;
		right: 0px;
		display: inline-block;
		text-align: right;
		width: 40px;
	}

	#simply-image-browse .simply-dialog-body > button i.select:before {
		width: 16px;
		display: inline-block;
		font-size: 20px;
		border-left: 1px solid #ddd;
		padding: 10px;
		border-bottom: 1px solid #ddd;
		color: #ddd;
		border-bottom-left-radius: 15px;
		z-index: 1;
		background-color: rgba(255,255,255,0.3);
		vertical-align: top;
		box-sizing: content-box;
	}
	#simply-image-browse .simply-dialog-body.simply-selecting button i.select {
		position: absolute;
		top: 0px;
		left: 0px;
		bottom: 0px;
		right: 0px;
		width: auto;
	}
	#simply-image-browse .simply-dialog-body > button.simply-selected i.select:before {
		border-color: #999;
		color: #16B916;
		background-color: rgba(255,255,255,0.8);
	}
	@media (max-width: 481px) {
		#simply-image-browse .simply-dialog-body > button {
			width: 50%;
		}
		#simply-image-browse .simply-dialog-body > .simply-add-folder {
			width: 50%;
		}
	}
</style>
<script>
	editor.plugins.imageBrowse = {
		currentSel : null,
		currentField : null,
		currentJail : null,
		path : document.querySelector("[data-simply-images]") ? document.querySelector("[data-simply-images]").getAttribute("data-simply-images") : null,
		dialog : {
			open : function() {
				editor.plugins.imageBrowse.currentSel = vdSelectionState.get();
				editor.plugins.imageBrowse.currentField = editor.node.getEditableField();
				editor.plugins.imageBrowse.currentJail = null;

				vdSelectionState.save(editor.plugins.imageBrowse.currentSel);
				editor.plugins.dialog.open(document.getElementById('simply-image-browse'), editor.plugins.imageBrowse.dialog.update);
			},
			loadImages : function(url) {
				var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
				var parser = document.createElement("A");
				parser.href = url;
				if (editor.plugins.imageBrowse.currentJail === null) {
					editor.plugins.imageBrowse.currentJail = parser.href;
				}
				editor.plugins.imageBrowse.currentPath = parser.href;

				editor.storage.list(url, function(imageData) {
					var i;
					var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
					var newHtml = '';
					for (i=0; i<imageData.folders.length; i++) {
						if (imageData.folders[i].url.indexOf(editor.plugins.imageBrowse.currentJail) === 0) {
							newHtml += "<button data-simply-action='simply-image-browse-directory' data-value='" + imageData.folders[i].url + "'><i class='select fa fa-check'></i><i class='fa fa-folder'></i>" + imageData.folders[i].name + "</button>";
						}
					}
					for (i=0; i<imageData.images.length; i++) {
//						if (imageData.images[i].url.indexOf(editor.plugins.imageBrowse.currentJail) === 0) {
							var src = imageData.images[i].url;
							if (typeof imageData.images[i].src !== "undefined") {
								src = imageData.images[i].src;
							}

							newHtml += "<button data-simply-action='simply-image-browse-insert'><i class='select fa fa-check'></i><img data-simply-src='" + src + "'></button>";
//						}
					}
					targetList.innerHTML = newHtml;
					targetList.scrollTop = 0;
					editor.responsiveImages.init(targetList);
					document.querySelector("#simply-image-browse [data-simply-action=simply-image-browse-filter-same-size]").classList.remove("simply-selected");

					var selectors = targetList.querySelectorAll("i.select");
					for (i=0; i<selectors.length; i++) {
						selectors[i].addEventListener("click", function(evt) {
							this.parentNode.classList.toggle("simply-selected");
							evt.preventDefault();
							evt.stopPropagation();
							editor.plugins.imageBrowse.dialog.updateToolbar();
						});
					}
				});
			},
			update : function() {
				// var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
				editor.plugins.imageBrowse.dialog.loadImages(editor.plugins.imageBrowse.path);
			},
			updateToolbar : function() {
				window.setTimeout(function() {
					var targetList = document.querySelectorAll("#simply-image-browse .simply-dialog-body .simply-selected");
					var uploadButton = document.querySelector("#simply-image-browse li [data-simply-action='simply-image-browse-upload']");
					var addButton = document.querySelector("#simply-image-browse li [data-simply-action='simply-image-browse-add-folder']");
					var deleteButton = document.querySelector("#simply-image-browse li [data-simply-action='simply-image-browse-delete']");

					if (targetList.length === 0) {
						document.querySelector("#simply-image-browse .simply-dialog-body").classList.remove("simply-selecting");
						if (uploadButton) {
							uploadButton.parentNode.style.display = "block";
						}
						if (addButton) {
							addButton.parentNode.style.display = "block";
						}
						if (deleteButton) {
							deleteButton.parentNode.style.display = "none";
						}
					} else {
						document.querySelector("#simply-image-browse .simply-dialog-body").classList.add("simply-selecting");
						if (uploadButton) {
							uploadButton.parentNode.style.display = "none";
						}
						if (addButton) {
							addButton.parentNode.style.display = "none";
						}
						if (deleteButton) {
							deleteButton.parentNode.style.display = "block";
						}
					}
				}, 50);
			}
		},
		init : function() {
			if (editor.plugins.imageBrowse.path) {
				var target = document.querySelectorAll("#simply-image .simply-toolbar .simply-buttons, #simply-image-field .simply-toolbar .simply-buttons");
				if (target) {
					var i;
					for (i=0; i<target.length; i++) {
						var button = document.createElement("LI");
						button.innerHTML = '<button data-simply-action="simply-image-browse"><i class="fa fa-folder"></i>Browse</button>';
						target[i].appendChild(button);
					}

					target = document.querySelectorAll('[data-simply-action="simply-image-src"]');
					if (target) {
						for (i=0; i<target.length; i++) {
							var button = document.createElement("div");
							button.innerHTML = '<button data-simply-action="simply-image-browse"><i class="fa fa-folder"></i></button>';
							target[i].parentNode.querySelector("label").appendChild(button.firstChild);
						}
					}
				} else {
					window.setTimeout(editor.plugins.imageBrowse.init, 200);
				}
			}

			if (editor.storage.file && typeof editor.storage.file.save === "function") {
				document.querySelector("#simply-image-browse").addEventListener("drop", function(evt) {
					evt.preventDefault();
					editor.plugins.imageBrowse.handleFiles(evt.dataTransfer.files);
				});
				document.querySelector("#simply-image-browse input[type='file']").addEventListener("change", function(evt) {
					editor.plugins.imageBrowse.handleFiles(this.files);
				});
			} else {
				var uploadButton = document.querySelector('[data-simply-action="simply-image-browse-upload"]');
				uploadButton.parentNode.parentNode.removeChild(uploadButton.parentNode);

				var addButton = document.querySelector('[data-simply-action="simply-image-browse-add-folder"]');
				addButton.parentNode.parentNode.removeChild(addButton.parentNode);
			}

			if (editor.storage.file && typeof editor.storage.file.delete === "function") {
				// Do nothing;
			} else {
				var deleteButton = document.querySelector('[data-simply-action="simply-image-browse-delete"]');
				deleteButton.parentNode.parentNode.removeChild(deleteButton.parentNode);
			}

			document.querySelector("#simply-image-browse").addEventListener("DOMNodeInserted", editor.plugins.imageBrowse.dialog.updateToolbar);
			document.querySelector("#simply-image-browse").addEventListener("DOMNodeRemoved",editor.plugins.imageBrowse.dialog.updateToolbar);

			var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
			new Slip(targetList); // slip is used for the tap-hold timing;
			targetList.addEventListener("slip:beforereorder", function(evt) {
				var targetButton = evt.target;
				if (targetButton.tagName.toLowerCase() == "i") {
					targetButton = targetButton.parentNode;
				}
				targetButton.classList.toggle("simply-selected");
				editor.plugins.imageBrowse.dialog.updateToolbar();

				targetButton.addEventListener("click", editor.plugins.imageBrowse.cancelClick, true);
				targetButton.addEventListener("mouseup", function(evt) {
					var currentButton = this;
					window.setTimeout(function() {
						currentButton.removeEventListener("click", editor.plugins.imageBrowse.cancelClick, true);
					}, 50);
				});
				evt.preventDefault();
				evt.stopPropagation();
			});
		},
		cancelClick : function(evt) {
			evt.preventDefault();
			evt.stopPropagation();
		},

		handleFiles : function(files) {
			if (files.length) {
				for (var i=0; i<files.length; i++) {
					var subpath = editor.plugins.imageBrowse.currentPath.replace(editor.storage.endpoint, "");
					var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");

					var newButton = document.createElement("BUTTON");
					newButton.setAttribute("data-simply-action", "simply-image-uploading");
					newButton.innerHTML = "Uploading<br><progress value=0 max=100></progress><br>" + files[i].name;
					targetList.appendChild(newButton);
					newButton.querySelector("progress").setAttribute("data-simply-progress", subpath + files[i].name);

					var url = editor.plugins.imageBrowse.currentPath + files[i].name.replace(/[^A-Za-z0-9_\.-]/, "-");

					(function(targetButton, url) {
						editor.storage.file.save(subpath + files[i].name, files[i], function() {
							targetButton.innerHTML = "<i class='select fa fa-check'></i><img data-simply-src='" + url + "'>";
							targetButton.setAttribute("data-simply-action", "simply-image-browse-insert");
							editor.responsiveImages.init(targetButton);
						});
					}(newButton, url));
				}
			}
		}
	};

	editor.addAction("simply-image-browse", editor.plugins.imageBrowse.dialog.open);
	editor.addAction("simply-image-browse-directory", function(el) {
		editor.plugins.imageBrowse.dialog.loadImages(el.dataset.value);
	});
	editor.addAction("simply-image-browse-insert", function(el) {
		editor.actions["simply-image-src"](el.querySelector("img").getAttribute("src"));

		//var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
		//parent.setAttribute("src", el.querySelector("img").getAttribute("src"));
		editor.plugins.dialog.close();
	});
	editor.addAction("simply-image-browse-upload", function(el) {
		var target = el.parentNode.querySelector("input");
		muze.event.fire(target, "click");
	});
	editor.addAction("simply-image-browse-delete", function(el) {
		var targetList = document.querySelectorAll("#simply-image-browse .simply-dialog-body .simply-selected");
		var subpath;

		if (confirm("Delete all selected folders and images?")) {
			for (var i=0; i<targetList.length; i++) {
				if (targetList[i].querySelector("img")) {
					subpath = targetList[i].querySelector("img").getAttribute("src").replace(editor.storage.endpoint, "");
				} else {
					subpath = targetList[i].getAttribute("data-value").replace(editor.storage.endpoint, "");
				}
				(function(targetButton) {
					editor.storage.file.delete(subpath, function() {
						targetButton.parentNode.removeChild(targetButton);
					});
				}(targetList[i]));
			};
		}
	});

	editor.addAction("simply-image-handle-upload", function(el) {
		editor.plugins.imageBrowse.handleFiles(el.files);
	});
	editor.addAction("simply-image-handle-add-folder", function(el) {
		var subpath = editor.plugins.imageBrowse.currentPath.replace(editor.storage.endpoint, "");
		var filename = el.parentNode.querySelector("input").value;
		var url = editor.plugins.imageBrowse.currentPath + filename.replace(/[^A-Za-z0-9_\.-]/, "-") + '/';

		(function(targetButton, url) {
			editor.storage.file.save(subpath + filename + '/', '', function() {
				targetButton.innerHTML = "<button data-simply-action='simply-image-browse-directory' data-value='" + url + "'><i class='select fa fa-check'></i><i class='fa fa-folder'></i>" + filename + "/</button>";
				newButton = targetButton.querySelector("button");
				targetButton.parentNode.insertBefore(newButton, targetButton);
				targetButton.parentNode.removeChild(targetButton);
			});
		}(el.parentNode, url));
	});
	editor.addAction("simply-image-cancel-add-folder", function(el) {
		var target = el.parentNode;
		target.parentNode.removeChild(target);
	});
	editor.addAction("simply-image-browse-add-folder", function(el) {
		var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
		var addButton = document.createElement("DIV");
		addButton.classList.add("simply-add-folder");
		addButton.innerHTML = '<i class="fa fa-folder"></i>';
		var addInput = document.createElement("input");
		addInput.type = "text";
		addInput.value = "new-folder";

		addSubmit = document.createElement("button");
		addSubmit.setAttribute("data-simply-action", "simply-image-handle-add-folder");
		addSubmit.classList.add('simply-add');
		addSubmit.innerHTML = '<i class="fa fa-check"></i>Add';

		addCancel = document.createElement("button");
		addCancel.setAttribute("data-simply-action", "simply-image-cancel-add-folder");
		addCancel.classList.add('simply-cancel');
		addCancel.innerHTML = '<i class="fa fa-times"></i>';
		addButton.appendChild(addInput);
		addButton.appendChild(addSubmit);
		addButton.appendChild(addCancel);
		targetList.appendChild(addButton);
		addInput.addEventListener("input", function(evt) {
			this.value = this.value.replace(/[^A-Za-z0-9_\.-]/g, '');
		});

		addInput.addEventListener("keydown", function(evt) {
			if (evt.keyCode == 13) { // enter
				muze.event.fire(addSubmit, "click");
				evt.stopPropagation();
			} else if (evt.keyCode == 27) { // ESC
				muze.event.fire(addCancel, "click");
				evt.stopPropagation();
			}
		});

		addInput.select();
		addInput.focus();
		window.setTimeout(function() { // give the mobile keyboard time to pop up;
			targetList.scrollTop = targetList.scrollHeight; // scroll the new element into view;
		}, 500);
	});

	editor.addAction("simply-image-browse-filter-same-size", function(el) {
		var parent = vdSelection.getNode(editor.plugins.imageBrowse.currentSel);
		var currentWidth = parent.naturalWidth;
		var currentHeight = parent.naturalHeight;
		var targetList = document.querySelector("#simply-image-browse .simply-dialog-body");
		var imageList = targetList.querySelectorAll("button img");
		if (el.classList.contains("simply-selected")) {
			for (var i=0; i<imageList.length; i++) {
				imageList[i].parentNode.style.display = "inline-block";
			}
			el.classList.remove("simply-selected");
		} else {
			for (var i=0; i<imageList.length; i++) {
				if (
					imageList[i].naturalWidth == parent.naturalWidth &&
					imageList[i].naturalHeight == parent.naturalHeight
				) {
					imageList[i].parentNode.style.display = "inline-block";
				} else {
					imageList[i].parentNode.style.display = "none";
				}
			}
			el.classList.add("simply-selected");
		}
	});

	editor.plugins.imageBrowse.init();
</script>