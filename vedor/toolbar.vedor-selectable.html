<script>
	(function() {
		var removeMouseSelectionEvent;
		var removeTouchSelectionEvent;
	
		var handleItemSelect = function(event) {
			var target = muze.event.target(event);
			while(!target.getAttribute("data-vedor-selectable") && target.parentNode) {
				if (target.getAttribute("contenteditable")) {
					return;
				}
			
				target = target.parentNode;
			}

			var sel = vdSelectionState.get();
			sel.selectNode(target);
			sel.startContainer.ownerDocument.defaultView.getSelection().removeAllRanges();
			sel.startContainer.ownerDocument.defaultView.getSelection().addRange(sel);
			vdSelectionState.save(sel);
			sel.startContainer.ownerDocument.defaultView.getSelection().removeAllRanges()
			editor.context.update();
		
			window.setTimeout(function() {
				removeMouseSelectionEvent = muze.event.attach(document, "mousedown", function() {
					muze.event.detach(document, "mousedown", removeMouseSelectionEvent);
					muze.event.detach(document, "touchstart", removeTouchSelectionEvent);
					vdSelectionState.remove(sel);
				});
				removeTouchSelectionEvent = muze.event.attach(document, "touchstart", function() {
					muze.event.detach(document, "mousedown", removeMouseSelectionEvent);
					muze.event.detach(document, "touchstart", removeTouchSelectionEvent);
					vdSelectionState.remove(sel);
				});
			}, 50);
		}
	
		var bindSelectables = function() {
			var listItems = document.querySelectorAll("[data-vedor-selectable]");
			for (var i=0; i<listItems.length; i++) {
				listItems[i].addEventListener('click', handleItemSelect);
			}
		}
		
		document.addEventListener("vedor-selectable-inserted", bindSelectables);

		editor.addToolbar({
			name: 'vedor-selectable',
			init : bindSelectables
		});
	})();
</script>